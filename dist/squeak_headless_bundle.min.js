self.Squeak={},self.SqueakJS={};var localStorage=self.localStorage;try{if((localStorage["squeak-foo:"]="bar")!==localStorage["squeak-foo:"])throw Error();delete localStorage["squeak-foo:"]}catch(t){localStorage={}}function ConsolePlugin(){return{getModuleName:function(){return"ConsolePlugin"},interpreterProxy:null,setInterpreter:function(t){return this.interpreterProxy=t,!0},"primitiveLog:level:":function(t){if(2!==t)return!1;var e=this.interpreterProxy.stackValue(1).bytesAsString(),s=this.interpreterProxy.stackValue(0).bytesAsString();return console[s](e),this.interpreterProxy.pop(t),!0}}}function registerConsolePlugin(){"object"==typeof Squeak&&Squeak.registerExternalModule?Squeak.registerExternalModule("ConsolePlugin",ConsolePlugin()):self.setTimeout(registerConsolePlugin,100)}function runImage(t,e){var i=new Squeak.Image(e.replace(/\.image$/i,""));i.readFromBuffer(t,function(){var s={vmOptions:["-vm-display-null","-nodisplay"]},t=new Squeak.Interpreter(i,s);!function e(){try{t.interpret(50,function(t){!options.ignoreQuit&&s.quitFlag||setTimeout(e,"sleep"===t?10:t)})}catch(t){console.error("Failure during Squeak run: ",t)}}()})}function fetchImageAndRun(e,t){fetch(e,{method:"GET",mode:"cors",cache:"no-store"}).then(function(t){if(!t.ok)throw new Error("Response not OK: "+t.status);return t.arrayBuffer()}).then(function(t){runImage(t,e)}).catch(function(t){console.error("Failed to retrieve image",t)})}self.Squeak.Settings=localStorage,Object.extend=function(t){for(var e=1;e<arguments.length;e++)if("object"==typeof arguments[e])for(var s in arguments[e])t[s]=arguments[e][s]},Function.prototype.subclass=function(t){function e(){return this.initialize&&this.initialize.apply(this,arguments),this}function s(){}s.prototype=this.prototype,e.prototype=new s;for(var i=1;i<arguments.length;i++)Object.extend(e.prototype,arguments[i]);var r=t.split("."),n=r.pop();return(0<r.length?r.reduce(function(t,e){return t[e]},self):self)[n]=e},Object.extend(Squeak,"version",{vmVersion:"SqueakJS 0.9.8",vmDate:"2020-01-26",vmBuild:"unknown",vmPath:"unknown",vmFile:"vm.js",platformName:"SqueakJS",platformSubtype:"unknown",osVersion:"unknown",windowSystem:"unknown"},"object header",{HeaderTypeMask:3,HeaderTypeSizeAndClass:0,HeaderTypeClass:1,HeaderTypeFree:2,HeaderTypeShort:3},"special objects",{splOb_NilObject:0,splOb_FalseObject:1,splOb_TrueObject:2,splOb_SchedulerAssociation:3,splOb_ClassBitmap:4,splOb_ClassInteger:5,splOb_ClassString:6,splOb_ClassArray:7,splOb_SmalltalkDictionary:8,splOb_ClassFloat:9,splOb_ClassMethodContext:10,splOb_ClassBlockContext:11,splOb_ClassPoint:12,splOb_ClassLargePositiveInteger:13,splOb_TheDisplay:14,splOb_ClassMessage:15,splOb_ClassCompiledMethod:16,splOb_TheLowSpaceSemaphore:17,splOb_ClassSemaphore:18,splOb_ClassCharacter:19,splOb_SelectorDoesNotUnderstand:20,splOb_SelectorCannotReturn:21,splOb_TheInputSemaphore:22,splOb_SpecialSelectors:23,splOb_CharacterTable:24,splOb_SelectorMustBeBoolean:25,splOb_ClassByteArray:26,splOb_ClassProcess:27,splOb_CompactClasses:28,splOb_TheTimerSemaphore:29,splOb_TheInterruptSemaphore:30,splOb_FloatProto:31,splOb_SelectorCannotInterpret:34,splOb_MethodContextProto:35,splOb_ClassBlockClosure:36,splOb_BlockContextProto:37,splOb_ExternalObjectsArray:38,splOb_ClassPseudoContext:39,splOb_ClassTranslatedMethod:40,splOb_TheFinalizationSemaphore:41,splOb_ClassLargeNegativeInteger:42,splOb_ClassExternalAddress:43,splOb_ClassExternalStructure:44,splOb_ClassExternalData:45,splOb_ClassExternalFunction:46,splOb_ClassExternalLibrary:47,splOb_SelectorAboutToReturn:48,splOb_SelectorRunWithIn:49,splOb_SelectorAttemptToAssign:50,splOb_PrimErrTableIndex:51,splOb_ClassAlien:52,splOb_InvokeCallbackSelector:53,splOb_ClassUnsafeAlien:54,splOb_ClassWeakFinalizer:55},"known classes",{Class_superclass:0,Class_mdict:1,Class_format:2,Class_instVars:null,Class_name:6,Context_sender:0,Context_instructionPointer:1,Context_stackPointer:2,Context_method:3,Context_closure:4,Context_receiver:5,Context_tempFrameStart:6,Context_smallFrameSize:16,Context_largeFrameSize:56,BlockContext_caller:0,BlockContext_argumentCount:3,BlockContext_initialIP:4,BlockContext_home:5,Closure_outerContext:0,Closure_startpc:1,Closure_numArgs:2,Closure_firstCopiedValue:3,Stream_array:0,Stream_position:1,Stream_limit:2,ProcSched_processLists:0,ProcSched_activeProcess:1,Link_nextLink:0,LinkedList_firstLink:0,LinkedList_lastLink:1,Semaphore_excessSignals:2,Mutex_owner:2,Proc_suspendedContext:1,Proc_priority:2,Proc_myList:3,Assn_key:0,Assn_value:1,MethodDict_array:1,MethodDict_selectorStart:2,Message_selector:0,Message_arguments:1,Message_lookupClass:2,Point_x:0,Point_y:1,LargeInteger_bytes:0,LargeInteger_neg:1,WeakFinalizationList_first:0,WeakFinalizerItem_list:0,WeakFinalizerItem_next:1},"constants",{MinSmallInt:-1073741824,MaxSmallInt:1073741823,NonSmallInt:-1342177280,MillisecondClockMask:536870911},"error codes",{PrimNoErr:0,PrimErrGenericFailure:1,PrimErrBadReceiver:2,PrimErrBadArgument:3,PrimErrBadIndex:4,PrimErrBadNumArgs:5,PrimErrInappropriate:6,PrimErrUnsupported:7,PrimErrNoModification:8,PrimErrNoMemory:9,PrimErrNoCMemory:10,PrimErrNotFound:11,PrimErrBadMethod:12,PrimErrNamedInternal:13,PrimErrObjectMayMove:14,PrimErrLimitExceeded:15,PrimErrObjectIsPinned:16,PrimErrWritePastObject:17},"modules",{externalModules:Squeak.externalModules||{},registerExternalModule:function(t,e){this.externalModules[t]=e}},"time",{Epoch:Date.UTC(1901,0,1)+6e4*(new Date).getTimezoneOffset(),EpochUTC:Date.UTC(1901,0,1),totalSeconds:function(){return Math.floor((Date.now()-Squeak.Epoch)/1e3)}},"utils",{bytesAsString:function(t){for(var e=[],s=0;s<t.length;)e.push(String.fromCharCode.apply(null,t.subarray(s,s+=16348)));return e.join("")}}),Object.subclass("Squeak.Object","initialization",{initInstanceOf:function(t,e,s,i){this.sqClass=t,this.hash=s;var r=t.pointers[Squeak.Class_format],n=(r>>1&63)+(r>>10&192)-1;this._format=r>>7&15,this._format<8?6!=this._format?0<n+e&&(this.pointers=this.fillArray(n+e,i)):0<e&&(t.isFloatClass?(this.isFloat=!0,this.float=0):this.words=new Uint32Array(e)):0<e&&(this.bytes=new Uint8Array(e))},initAsClone:function(t,e){this.sqClass=t.sqClass,this.hash=e,this._format=t._format,t.isFloat?(this.isFloat=t.isFloat,this.float=t.float):(t.pointers&&(this.pointers=t.pointers.slice(0)),t.words&&(this.words=new Uint32Array(t.words)),t.bytes&&(this.bytes=new Uint8Array(t.bytes)))},initFromImage:function(t,e,s,i){this.oop=t,this.sqClass=e,this._format=s,this.hash=i},classNameFromImage:function(t,e){var s=t[e[this.oop][Squeak.Class_name]];if(s&&8<=s._format&&s._format<12){var i=e[s.oop],r=s.decodeBytes(i.length,i,0,3&s._format);return Squeak.bytesAsString(r)}return"Class"},renameFromImage:function(t,e,s){var i=this.sqClass<32?t[s[this.sqClass-1]]:t[this.sqClass];if(!i)return this;var r=i.instProto||i.classInstProto(i.classNameFromImage(t,e));if(!r)return this;var n=new r;return n.oop=this.oop,n.sqClass=this.sqClass,n._format=this._format,n.hash=this.hash,n},installFromImage:function(t,e,s,i,r,n){var a=this.sqClass;this.sqClass=0<a&&a<32?t[s[a-1]]:t[a];var o=e[this.oop],h=o.length;if(this._format<5){if(0<h){var c=o;this.pointers=this.decodePointers(h,c,t)}}else if(12<=this._format){var u=this.decodeWords(1,o,r)[0]>>10&255;c=this.decodeWords(1+u,o,r);this.pointers=this.decodePointers(1+u,c,t),this.bytes=this.decodeBytes(h-(1+u),o,1+u,3&this._format)}else if(8<=this._format)0<h&&(this.bytes=this.decodeBytes(h,o,0,3&this._format));else if(this.sqClass==i){if(this.isFloat=!0,this.float=this.decodeFloat(o,r,n),1.3797216632888e-310==this.float&&!Squeak.noFloatDecodeWorkaround&&(this.constructor.prototype.decodeFloat=this.decodeFloatDeoptimized,this.float=this.decodeFloat(o,r,n),1.3797216632888e-310==this.float))throw Error("Cannot deoptimize decodeFloat")}else 0<h&&(this.words=this.decodeWords(h,o,r));this.mark=!1},decodePointers:function(t,e,s){for(var i=new Array(t),r=0;r<t;r++){var n=e[r];i[r]=1==(1&n)?n>>1:s[n]||42424242}return i},decodeWords:function(t,e,s){for(var i=new DataView(e.buffer,e.byteOffset),r=new Uint32Array(t),n=0;n<t;n++)r[n]=i.getUint32(4*n,s);return r},decodeBytes:function(t,e,s,i){var r=4*t-i,n=new Uint8Array(e.buffer,e.byteOffset+4*s,r),a=new Uint8Array(r);return a.set(n),a},decodeFloat:function(t,e,s){var i=new DataView(t.buffer,t.byteOffset);if(!e)return i.getFloat64(0,!1);if(s)return i.getFloat64(0,!0);var r=new ArrayBuffer(8),n=new DataView(r);return n.setUint32(0,i.getUint32(4)),n.setUint32(4,i.getUint32(0)),n.getFloat64(0,!0)},decodeFloatDeoptimized:function(t,e,s){var i=new DataView(t.buffer,t.byteOffset);if(!e)return i.getFloat64(0,!1);if(s)return i.getFloat64(0,!0);var r=new ArrayBuffer(8),n=new DataView(r);return n.setUint32(0,i.getUint32(4)),n.setUint32(4,i.getUint32(0)),n.getFloat64(0,!0)},fillArray:function(t,e){for(var s=[],i=0;i<t;i++)s[i]=e;return s}},"testing",{isWords:function(){return 6===this._format},isBytes:function(){var t=this._format;return 8<=t&&t<=11},isWordsOrBytes:function(){var t=this._format;return 6==t||8<=t&&t<=11},isPointers:function(){return this._format<=4},isWeak:function(){return 4===this._format},isMethod:function(){return 12<=this._format},sameFormats:function(t,e){return t<8?t===e:(12&t)==(12&e)},sameFormatAs:function(t){return this.sameFormats(this._format,t._format)}},"printing",{toString:function(){return this.sqInstName()},bytesAsString:function(){return this.bytes?Squeak.bytesAsString(this.bytes):""},bytesAsNumberString:function(t){if(!this.bytes)return"";for(var e="0123456789ABCDEF",s=[],i=0,r=this.bytes.length-1;0<=r;r--)s.push(e[this.bytes[r]>>4]),s.push(e[15&this.bytes[r]]),i=256*i+this.bytes[r];var n=t?"-":"",a=9007199254740991<i?"â‰ˆ":"";return n+"16r"+s.join("")+" ("+a+n+i+"L)"},assnKeyAsString:function(){return this.pointers[Squeak.Assn_key].bytesAsString()},slotNameAt:function(t){var e=this.instSize();return t<=e?this.sqClass.allInstVarNames()[t-1]||"ivar"+(t-1):(t-e).toString()},sqInstName:function(){if(this.isNil)return"nil";if(this.isTrue)return"true";if(this.isFalse)return"false";if(this.isFloat){var t=this.float.toString();return/\./.test(t)||(t+=".0"),t}var e=this.sqClass.className();if(/ /.test(e))return"the "+e;switch(e){case"String":case"ByteString":return"'"+this.bytesAsString()+"'";case"Symbol":case"ByteSymbol":return"#"+this.bytesAsString();case"Point":return this.pointers.join("@");case"Rectangle":return this.pointers.join(" corner: ");case"Association":case"ReadOnlyVariableBinding":return this.pointers.join("->");case"LargePositiveInteger":return this.bytesAsNumberString(!1);case"LargeNegativeInteger":return this.bytesAsNumberString(!0);case"Character":var s=this.pointers?this.pointers[0]:this.hash;return"$"+String.fromCharCode(s)+" ("+s.toString()+")"}return/^[aeiou]/i.test(e)?"an"+e:"a"+e}},"accessing",{pointersSize:function(){return this.pointers?this.pointers.length:0},bytesSize:function(){return this.bytes?this.bytes.length:0},wordsSize:function(){return this.isFloat?2:this.words?this.words.length:0},instSize:function(){var t=this._format;return 4<t||2===t?0:t<2?this.pointersSize():this.sqClass.classInstSize()},indexableSize:function(t){var e=this._format;return e<2?-1:3===e&&t.vm.isContext(this)&&!t.allowAccessBeyondSP?this.pointers[Squeak.Context_stackPointer]:e<6?this.pointersSize()-this.instSize():e<8?this.wordsSize():e<12?this.bytesSize():this.bytesSize()+4*this.pointersSize()},floatData:function(){var t=new ArrayBuffer(8),e=new DataView(t);return e.setFloat64(0,this.float,!1),e},wordsAsFloat32Array:function(){return this.float32Array||this.words&&(this.float32Array=new Float32Array(this.words.buffer))},wordsAsFloat64Array:function(){return this.float64Array||this.words&&(this.float64Array=new Float64Array(this.words.buffer))},wordsAsInt32Array:function(){return this.int32Array||this.words&&(this.int32Array=new Int32Array(this.words.buffer))},wordsAsInt16Array:function(){return this.int16Array||this.words&&(this.int16Array=new Int16Array(this.words.buffer))},wordsAsUint16Array:function(){return this.uint16Array||this.words&&(this.uint16Array=new Uint16Array(this.words.buffer))},wordsAsUint8Array:function(){return this.uint8Array||this.words&&(this.uint8Array=new Uint8Array(this.words.buffer))},wordsOrBytes:function(){return this.words?this.words:this.uint32Array?this.uint32Array:this.bytes?this.uint32Array=new Uint32Array(this.bytes.buffer,0,this.bytes.length>>>2):null},setAddr:function(t){var e=this.snapshotSize();return this.oop=t+4*e.header,t+4*(e.header+e.body)},snapshotSize:function(){var t=this.isFloat?2:this.words?this.words.length:this.pointers?this.pointers.length:0;return this.bytes&&(t+=this.bytes.length+3>>>2),{header:63<++t?2:this.sqClass.isCompact?0:1,body:t}},addr:function(){return this.oop-4*this.snapshotSize().header},totalBytes:function(){var t=this.snapshotSize();return 4*(t.header+t.body)},writeTo:function(t,e,s){this.bytes&&(this._format|=3&-this.bytes.length);var i=e,r=this.snapshotSize(),n=(15&this._format)<<8|(4095&this.hash)<<17;switch(r.header){case 2:t.setUint32(e,r.body<<2|Squeak.HeaderTypeSizeAndClass),e+=4,t.setUint32(e,this.sqClass.oop|Squeak.HeaderTypeSizeAndClass),e+=4,t.setUint32(e,n|Squeak.HeaderTypeSizeAndClass),e+=4;break;case 1:t.setUint32(e,this.sqClass.oop|Squeak.HeaderTypeClass),e+=4,t.setUint32(e,n|r.body<<2|Squeak.HeaderTypeClass),e+=4;break;case 0:var a=s.compactClasses.indexOf(this.sqClass)+1;t.setUint32(e,n|a<<12|r.body<<2|Squeak.HeaderTypeShort),e+=4}if(this.isFloat)t.setFloat64(e,this.float),e+=8;else if(this.words)for(var o=0;o<this.words.length;o++)t.setUint32(e,this.words[o]),e+=4;else if(this.pointers)for(o=0;o<this.pointers.length;o++)t.setUint32(e,s.objectToOop(this.pointers[o])),e+=4;if(this.bytes){for(o=0;o<this.bytes.length;o++)t.setUint8(e++,this.bytes[o]);e+=3&-this.bytes.length}if(e!==i+this.totalBytes())throw Error("written size does not match");return e}},"as class",{classInstFormat:function(){return this.pointers[Squeak.Class_format]>>7&15},classInstSize:function(){var t=this.pointers[Squeak.Class_format];return(t>>10&192)+(t>>1&63)-1},instVarNames:function(){for(var t=3;t<=4;t++){var e=this.pointers[t].pointers;if(e&&e.length&&e[0].bytes)return e.map(function(t){return t.bytesAsString()})}return[]},allInstVarNames:function(){var t=this.superclass();return t.isNil?this.instVarNames():t.allInstVarNames().concat(this.instVarNames())},superclass:function(){return this.pointers[0]},className:function(){if(!this.pointers)return"_NOTACLASS_";for(var t=6;t<=7;t++){if((i=this.pointers[t])&&i.bytes)return i.bytesAsString()}for(var e=5;e<=6;e++){var s=this.pointers[e];if(s&&s.pointers)for(t=6;t<=7;t++){var i;if((i=s.pointers[t])&&i.bytes)return i.bytesAsString()+" class"}}return"_SOMECLASS_"},defaultInst:function(){return Squeak.Object},classInstProto:function(t){if(this.instProto)return this.instProto;var e=this.defaultInst();try{var s=(t=t||this.className()).replace(/[^A-Za-z0-9]/g,"_");s="UndefinedObject"===s?"nil":"True"===s?"true_":"False"===s?"false_":(/^[AEIOU]/.test(s)?"an":"a")+s,(e=new Function("return function "+s+"() {};")()).prototype=this.defaultInst().prototype}catch(t){}return Object.defineProperty(this,"instProto",{value:e}),e}},"as method",{methodNumLits:function(){return this.pointers[0]>>9&255},methodNumArgs:function(){return this.pointers[0]>>24&15},methodPrimitiveIndex:function(){var t=805306879&this.pointers[0];return 511<t?(511&t)+(t>>19):t},methodClassForSuper:function(){return this.pointers[this.methodNumLits()].pointers[Squeak.Assn_value]},methodNeedsLargeFrame:function(){return 0<(131072&this.pointers[0])},methodAddPointers:function(t){this.pointers=t},methodTempCount:function(){return this.pointers[0]>>18&63},methodGetLiteral:function(t){return this.pointers[1+t]},methodGetSelector:function(t){return this.pointers[1+t]}},"as context",{contextHome:function(){return this.contextIsBlock()?this.pointers[Squeak.BlockContext_home]:this},contextIsBlock:function(){return"number"==typeof this.pointers[Squeak.BlockContext_argumentCount]},contextMethod:function(){return this.contextHome().pointers[Squeak.Context_method]},contextSender:function(){return this.pointers[Squeak.Context_sender]},contextSizeWithStack:function(t){if(t&&t.activeContext===this)return t.sp+1;var e=this.pointers[Squeak.Context_stackPointer];return Squeak.Context_tempFrameStart+("number"==typeof e?e:0)}}),Squeak.Object.subclass("Squeak.ObjectSpur","initialization",{initInstanceOf:function(t,e,s,i){this.sqClass=t,this.hash=s;var r=t.pointers[Squeak.Class_format],n=65535&r,a=r>>16&31;(this._format=a)<12?a<10?0<n+e&&(this.pointers=this.fillArray(n+e,i)):0<e&&(t.isFloatClass?(this.isFloat=!0,this.float=0):this.words=new Uint32Array(e)):0<e&&(this.bytes=new Uint8Array(e))},installFromImage:function(t,e,s,i,r,n){var a=this.sqClass;if(a<32)throw Error("Invalid class ID: "+a);if(this.sqClass=s[a],!this.sqClass)throw Error("Class ID not in class table: "+a);var o=e[this.oop],h=o.length;switch(this._format){case 0:case 1:case 2:case 3:case 4:case 5:if(0<h){var c=o;this.pointers=this.decodePointers(h,c,t,n)}break;case 10:if(this.sqClass===i){if(this.isFloat=!0,this.float=this.decodeFloat(o,r,!0),1.3797216632888e-310==this.float&&!Squeak.noFloatDecodeWorkaround&&(this.constructor.prototype.decodeFloat=this.decodeFloatDeoptimized,this.float=this.decodeFloat(o,r,!0),1.3797216632888e-310==this.float))throw Error("Cannot deoptimize decodeFloat")}else 0<h&&(this.words=this.decodeWords(h,o,r));break;case 12:case 13:throw Error("16 bit arrays not supported yet");case 16:case 17:case 18:case 19:0<h&&(this.bytes=this.decodeBytes(h,o,0,3&this._format));break;case 24:case 25:case 26:case 27:var u=this.decodeWords(1,o,r)[0];if(2147483648&u)throw Error("Alternate bytecode set not supported");var l=u>>1&32767;c=this.decodeWords(1+l,o,r);this.pointers=this.decodePointers(1+l,c,t,n),this.bytes=this.decodeBytes(h-(1+l),o,1+l,3&this._format);break;default:throw Error("Unknown object format: "+this._format)}this.mark=!1},decodePointers:function(t,e,s,i){for(var r=new Array(t),n=0;n<t;n++){var a=e[n];r[n]=1==(1&a)?a>>1:2==(3&a)?i(a>>>2):s[a]||42424242}return r},initInstanceOfChar:function(t,e){this.oop=e<<2|2,this.sqClass=t,this.hash=e,this._format=7,this.mark=!0},classNameFromImage:function(t,e){var s=t[e[this.oop][Squeak.Class_name]];if(s&&16<=s._format&&s._format<24){var i=e[s.oop],r=s.decodeBytes(i.length,i,0,7&s._format);return Squeak.bytesAsString(r)}return"Class"},renameFromImage:function(t,e,s){var i=s[this.sqClass];if(!i)return this;var r=i.instProto||i.classInstProto(i.classNameFromImage(t,e));if(!r)return this;var n=new r;return n.oop=this.oop,n.sqClass=this.sqClass,n._format=this._format,n.hash=this.hash,n}},"accessing",{instSize:function(){return this._format<2?this.pointersSize():this.sqClass.classInstSize()},indexableSize:function(t){var e=this._format;return e<2?-1:3===e&&t.vm.isContext(this)?this.pointers[Squeak.Context_stackPointer]:e<6?this.pointersSize()-this.instSize():e<12?this.wordsSize():e<16?this.shortsSize():e<24?this.bytesSize():4*this.pointersSize()+this.bytesSize()},snapshotSize:function(){var t=this.isFloat?2:this.words?this.words.length:this.pointers?this.pointers.length:0;this.bytes&&(t+=this.bytes.length+3>>>2);var e=255<=t?2:0;return t+=1&t,(t+=2)<4&&(t=4),{header:e,body:t}},writeTo:function(t,e,s,i){var r=this.isFloat?2:this.words?this.words.length:this.pointers?this.pointers.length:0;this.bytes&&(r+=this.bytes.length+3>>>2,this._format|=3&-this.bytes.length);var n=e,a=this._format<<24|4194303&this.sqClass.hash,o=r<<24|4194303&this.hash;if(255<=r&&(t.setUint32(e,r,s),e+=4,o=255<<24|4194303&this.hash,t.setUint32(e,o,s),e+=4),t.setUint32(e,a,s),e+=4,t.setUint32(e,o,s),e+=4,this.isFloat)t.setFloat64(e,this.float,s),e+=8;else if(this.words)for(var h=0;h<this.words.length;h++)t.setUint32(e,this.words[h],s),e+=4;else if(this.pointers)for(h=0;h<this.pointers.length;h++)t.setUint32(e,i(this.pointers[h]),s),e+=4;if(this.bytes){for(h=0;h<this.bytes.length;h++)t.setUint8(e++,this.bytes[h]);e+=3&-this.bytes.length}if((e+=0===r?8:4*(1&r))!==n+this.totalBytes())throw Error("written size does not match");return e}},"testing",{isBytes:function(){var t=this._format;return 16<=t&&t<=23},isPointers:function(){return this._format<=6},isWords:function(){return 10===this._format},isWordsOrBytes:function(){var t=this._format;return 10===t||16<=t&&t<=23},isWeak:function(){return 4===this._format},isMethod:function(){return 24<=this._format},sameFormats:function(t,e){return t<16?t===e:(248&t)==(248&e)}},"as class",{defaultInst:function(){return Squeak.ObjectSpur},classInstFormat:function(){return this.pointers[Squeak.Class_format]>>16&31},classInstSize:function(){return 65535&this.pointers[Squeak.Class_format]},classByteSizeOfInstance:function(t){var e=this.classInstFormat(),s=this.classInstSize();return s+=e<9?t:16<=e?(t+3)/4|0:12<=e?(t+1)/2|0:10<=e?t:2*t,s+=1&s,(s+=255<=s?4:2)<4&&(s=4),4*s}},"as method",{methodNumLits:function(){return 32767&this.pointers[0]},methodPrimitiveIndex:function(){return 0==(65536&this.pointers[0])?0:this.bytes[1]+256*this.bytes[2]}}),Object.subclass("Squeak.Image","about",{about:function(){}},"initializing",{initialize:function(t){this.totalMemory=1e8,this.name=t,this.gcCount=0,this.gcMilliseconds=0,this.pgcCount=0,this.pgcMilliseconds=0,this.gcTenured=0,this.allocationCount=0,this.oldSpaceCount=0,this.youngSpaceCount=0,this.newSpaceCount=0,this.hasNewInstances={}},readFromBuffer:function(r,e,s){console.log("squeak: reading "+this.name+" ("+r.byteLength+" bytes)"),this.startupTime=Date.now();function n(){var t=i.getUint32(o,a);return o+=4,t}function t(t,e){if(e){for(var s=[];s.length<t;)s.push(n());return s}var i=new Uint32Array(r,o,t);return o+=4*t,i}for(var i=new DataView(r),a=!1,o=0,h=[6501,6502,6504,6505,6521,68e3,68002,68003,68021],c=0,u=0;a=!a,o=u,c=n(),!(0<=h.indexOf(c));)if(a||(u+=512),512<u)throw Error("bad image version");this.version=c;var l=0<=[6505,6521,68003,68021].indexOf(c);if(this.hasClosures=0<=[6504,6505,6521,68002,68003,68021].indexOf(c),this.isSpur=0<=[6521,68021].indexOf(c),68e3<=c)throw Error("64 bit images not supported yet");var p=n(),m=n(),d=n(),f=n();this.lastHash=n(),this.savedHeaderWords=[];for(var v=0;v<6;v++)this.savedHeaderWords.push(n());var k,b=n(),S={},g={},C=u+p;if(o=C,this.isSpur){this.oldSpaceBytes=b-16;for(var O=o+b,P=0,I=null,y=null,x=0,q={};o<O;){for(;o<O-16;){var _=o,w=n(),j=n(),A=j>>>24;255===A&&(A=w,w=n(),j=n());E=P+o-8-C;var F=4194303&w;K=4194303&j,U=t(A,(R=w>>>24&31)<10&&0<F);if(o+=4*(A<2?2-A:1&A),32<=F)(D=new Squeak.ObjectSpur).initFromImage(E,F,R,K),k&&(k.nextObject=D),this.oldSpaceCount++,k=D,S[d+E]=D,g[E]=U,q[E]=x;else x+=o-_,I?y=y||U:I=U,F&&(S[d+E]=U)}if(o!==O-16)throw Error("invalid segment");var N=n(),B=n(),L=n();n();if(0!==L){var M=4278190080&B?4*(16777215&N):0;O+=L,P+=M,x+=16+M,this.oldSpaceBytes+=M+L}}this.oldSpaceBytes-=x,this.firstOldObject=S[d],this.lastOldObject=D}else{for(;o<C+m;){var T=0,V=0,z=n();switch(z&Squeak.HeaderTypeMask){case Squeak.HeaderTypeSizeAndClass:T=z>>>2,V=n(),z=n();break;case Squeak.HeaderTypeClass:V=z-Squeak.HeaderTypeClass,T=(z=n())>>>2&63;break;case Squeak.HeaderTypeShort:T=z>>>2&63,V=z>>>12&31;break;case Squeak.HeaderTypeFree:throw Error("Unexpected free block")}var R,D,E=o-4-C,K=z>>>17&4095,U=t(--T,(R=z>>>8&15)<5);(D=new Squeak.Object).initFromImage(E,V,R,K),V<32&&(D.hash|=268435456),k&&(k.nextObject=D),this.oldSpaceCount++,k=D,S[d+E]=D,g[E]=U}this.firstOldObject=S[d+4],this.lastOldObject=D,this.oldSpaceBytes=m}var W=S[f],G=this.isSpur?this.spurClassTable(S,g,y,W):g[S[g[W.oop][Squeak.splOb_CompactClasses]].oop],H=null;for(D=this.firstOldObject,k=null;D;)k=H,H=D.renameFromImage(S,g,G),k?k.nextObject=H:this.firstOldObject=H,S[d+D.oop]=H,D=D.nextObject;this.lastOldObject=H;var J=S[f],Y=g[S[g[J.oop][Squeak.splOb_CompactClasses]].oop],X=S[g[J.oop][Squeak.splOb_ClassFloat]];if(this.isSpur){var Q=S[g[J.oop][Squeak.splOb_ClassCharacter]];this.initCharacterTable(Q),Y=this.spurClassTable(S,g,y,J),l=this.getCharacter.bind(this),this.initSpurOverrides()}var Z=this.firstOldObject,$=0,tt=function(){if(Z){for(var t=$+(this.oldSpaceCount/20|0);Z&&$<t;)Z.installFromImage(S,g,Y,X,a,l),Z=Z.nextObject,$++;return s&&s($/this.oldSpaceCount),!0}return this.specialObjectsArray=J,this.decorateKnownObjects(),this.isSpur?this.fixSkippedOops(q):(this.fixCompiledMethods(),this.fixCompactOops()),!1}.bind(this);if(s)self.setTimeout(function t(){tt()?self.setTimeout(t,0):e&&e()},0);else{for(;tt(););e&&e()}},decorateKnownObjects:function(){var t=this.specialObjectsArray.pointers;if(t[Squeak.splOb_NilObject].isNil=!0,t[Squeak.splOb_TrueObject].isTrue=!0,t[Squeak.splOb_FalseObject].isFalse=!0,t[Squeak.splOb_ClassFloat].isFloatClass=!0,!this.isSpur){this.compactClasses=this.specialObjectsArray.pointers[Squeak.splOb_CompactClasses].pointers;for(var e=0;e<this.compactClasses.length;e++)this.compactClasses[e].isNil||(this.compactClasses[e].isCompact=!0)}Number.prototype.sqInstName||Object.defineProperty(Number.prototype,"sqInstName",{enumerable:!1,value:function(){return this.toString()}})},fixCompactOops:function(){if(!this.isSpur){for(var t=this.firstOldObject,e=0;t;){var s=268435455<t.hash;if(s!=!!t.sqClass.isCompact){var i=0===t.snapshotSize().header;s!=i&&(e+=i?-4:4)}t.hash&=268435455,t.oop+=e,t=t.nextObject}this.oldSpaceBytes+=e}},fixCompiledMethods:function(){if(!(6502<=this.version))for(var t=this.firstOldObject,e=this.specialObjectsArray.pointers[Squeak.splOb_ClassCompiledMethod];t;)t.isMethod()&&(t.sqClass=e),t=t.nextObject},fixSkippedOops:function(t){for(var e=this.firstOldObject;e;)e.oop-=t[e.oop],e=e.nextObject;if((e=this.lastOldObject).addr()+e.totalBytes()!==this.oldSpaceBytes)throw Error("image size doesn't match object sizes")}},"garbage collection - full",{fullGC:function(t){this.vm.addMessage("fullGC: "+t);var e=Date.now(),s=this.markReachableObjects();return this.removeUnmarkedOldObjects(),this.appendToOldObjects(s),this.finalizeWeakReferences(),this.allocationCount+=this.newSpaceCount,this.newSpaceCount=0,this.youngSpaceCount=0,this.hasNewInstances={},this.gcCount++,this.gcMilliseconds+=Date.now()-e,console.log("Full GC ("+t+"): "+(Date.now()-e)+" ms"),0<s.length?s[0]:null},gcRoots:function(){return this.vm.storeContextRegisters(),[this.specialObjectsArray,this.vm.activeContext]},markReachableObjects:function(){var t=this.gcRoots(),e=[];for(this.weakObjects=[];0<t.length;){var s=t.pop();if(!s.mark){s.oop<0&&e.push(s),s.mark=!0,s.sqClass.mark||t.push(s.sqClass);var i=s.pointers;if(i){var r=i.length;if(s.isWeak()&&(r=s.sqClass.classInstSize(),this.weakObjects.push(s)),this.vm.isContext(s))for(var n=r=s.contextSizeWithStack();n<i.length;n++)i[n]=this.vm.nilObj;for(n=0;n<r;n++)"object"!=typeof i[n]||i[n].mark||t.push(i[n])}}}return this.isSpur?e:e.sort(function(t,e){return e.oop-t.oop})},removeUnmarkedOldObjects:function(){var t=0,e=0,s=this.firstOldObject;for(s.mark=!1;;){var i=s.nextObject;if(!i)return this.lastOldObject=s,this.oldSpaceBytes-=e,void(this.oldSpaceCount-=t);if(i.dirty&&(i.dirty=!1),i.mark)(s=i).mark=!1,s.oop-=e;else{var r=i;s.nextObject=r.nextObject,r.oop=-++this.newSpaceCount,e+=r.totalBytes(),t++}}},appendToOldObjects:function(t){for(var e=this.lastOldObject,s=0;s<t.length;s++){var i=t[s];i.mark=!1,this.oldSpaceBytes=i.setAddr(this.oldSpaceBytes),e.nextObject=i,e=i}e.nextObject=null,this.lastOldObject=e,this.oldSpaceCount+=t.length,this.gcTenured+=t.length},tenureIfYoung:function(t){t.oop<0&&this.appendToOldObjects([t])},finalizeWeakReferences:function(){var t=this.weakObjects;this.weakObjects=null;for(var e=0;e<t.length;e++){for(var s=t[e],i=s.pointers,r=s.sqClass.classInstSize(),n=!1,a=r;a<i.length;a++)i[a].oop<0&&(i[a]=this.vm.nilObj,n=!0);if(n&&(this.vm.pendingFinalizationSignals++,2<=r)){var o=s.pointers[Squeak.WeakFinalizerItem_list];if(o.sqClass==this.vm.specialObjects[Squeak.splOb_ClassWeakFinalizer]){var h=o.pointers[Squeak.WeakFinalizationList_first];s.pointers[Squeak.WeakFinalizerItem_next]=h,o.pointers[Squeak.WeakFinalizationList_first]=s}}}0<this.vm.pendingFinalizationSignals&&this.vm.forceInterruptCheck()}},"garbage collection - partial",{partialGC:function(t){this.vm.addMessage("partialGC: "+t);var e=Date.now(),s=this.findYoungObjects();return this.appendToYoungSpace(s),this.finalizeWeakReferences(),this.cleanupYoungSpace(s),this.allocationCount+=this.newSpaceCount-s.length,this.youngSpaceCount=s.length,this.newSpaceCount=this.youngSpaceCount,this.pgcCount++,this.pgcMilliseconds+=Date.now()-e,console.log("Partial GC ("+t+"): "+(Date.now()-e)+" ms"),s[0]},youngRoots:function(){for(var t=this.gcRoots().filter(function(t){return t.oop<0}),e=this.firstOldObject;e;){if(e.dirty){for(var s=e.pointers,i=!1,r=0;r<s.length;r++){var n=s[r];"object"==typeof n&&n.oop<0&&(t.push(n),i=!0)}e.dirty=i}e=e.nextObject}return t},findYoungObjects:function(){var t=this.youngRoots(),e=[];for(this.weakObjects=[];0<t.length;){var s=t.pop();if(!s.mark){e.push(s),s.mark=!0,s.sqClass.oop<0&&t.push(s.sqClass);var i=s.pointers;if(i){var r=i.length;if(s.isWeak()&&(r=s.sqClass.classInstSize(),this.weakObjects.push(s)),this.vm.isContext(s))for(var n=r=s.contextSizeWithStack();n<i.length;n++)i[n]=this.vm.nilObj;for(n=0;n<r;n++){var a=i[n];"object"==typeof a&&a.oop<0&&t.push(i[n])}}}}return this.isSpur?e:e.sort(function(t,e){return e.oop-t.oop})},appendToYoungSpace:function(t){for(var e=this.lastOldObject.oop+1,s=0;s<t.length;s++){var i=t[s];this.hasNewInstances[i.oop]&&(delete this.hasNewInstances[i.oop],this.hasNewInstances[e]=!0),i.oop=e,i.nextObject=t[s+1],e++}},cleanupYoungSpace:function(t){for(var e=t[0],s=-1;e;)this.hasNewInstances[e.oop]&&(delete this.hasNewInstances[e.oop],this.hasNewInstances[s]=!0),e.oop=s,e.mark=!1,e=e.nextObject,s--}},"creating",{registerObject:function(t){return t.oop=-++this.newSpaceCount,this.lastHash=13849+27181*this.lastHash&4294967295,4095&this.lastHash},registerObjectSpur:function(t){return t.oop=-++this.newSpaceCount,0},instantiateClass:function(t,e,s){var i=new(t.classInstProto()),r=this.registerObject(i);return i.initInstanceOf(t,e,r,s),this.hasNewInstances[t.oop]=!0,i},clone:function(t){var e=new(t.sqClass.classInstProto()),s=this.registerObject(e);return e.initAsClone(t,s),this.hasNewInstances[e.sqClass.oop]=!0,e}},"operations",{bulkBecome:function(t,e,s,i){if(!t)return!e;var r=t.length;if(r!==e.length)return!1;var n=null;0<this.newSpaceCount?n=this.partialGC("become"):this.vm.storeContextRegisters();for(var a={},o=0;o<r;o++){if(!(c=t[o]).sqClass)return!1;if(a[c.oop])return!1;a[c.oop]=e[o]}if(s)for(o=0;o<r;o++){if(!(c=e[o]).sqClass)return!1;if(a[c.oop])return!1;a[c.oop]=t[o]}if(i)for(o=0;o<r;o++){if(!e[o].sqClass)return!1;var h=t[o].hash;t[o].hash=e[o].hash,e[o].hash=h}this.lastOldObject.nextObject=n;for(var c=this.firstOldObject;c;){var u=a[c.sqClass.oop];u&&(c.sqClass=u).oop<0&&(c.dirty=!0);var l=c.pointers;if(l)for(var p=0;p<l.length;p++)(u=a[l[p].oop])&&(l[p]=u).oop<0&&(c.dirty=!0);c=c.nextObject}return this.lastOldObject.nextObject=null,this.vm.flushMethodCacheAfterBecome(a),!0},objectAfter:function(t){return t.nextObject||this.nextObjectWithGC("nextObject",t)},someInstanceOf:function(t){for(var e=this.firstOldObject;e;){if(e.sqClass===t)return e;e=e.nextObject||this.nextObjectWithGCFor(e,t)}return null},nextInstanceAfter:function(t){for(var e=t.sqClass;;){if(!(t=t.nextObject||this.nextObjectWithGCFor(t,e)))return null;if(t.sqClass===e)return t}},nextObjectWithGC:function(t,e){var s=0<e.oop?0:this.youngSpaceCount;return this.newSpaceCount<=s?null:(e.oop<0&&this.fullGC(t),this.partialGC(t))},nextObjectWithGCFor:function(t,e){return this.hasNewInstances[e.oop]?this.nextObjectWithGC("instance of "+e.className(),t):null},allInstancesOf:function(t){for(var e=this.firstOldObject,s=[];e;)e.sqClass===t&&s.push(e),e=e.nextObject||this.nextObjectWithGCFor(e,t);return s},writeToBuffer:function(){function t(t){e.setUint32(s,t),s+=4}var e=new DataView(new ArrayBuffer(64+this.oldSpaceBytes)),s=0;for(t(this.formatVersion()),t(64),t(this.oldSpaceBytes),t(this.firstOldObject.addr()),t(this.objectToOop(this.specialObjectsArray)),t(this.lastHash),t(52429400);s<64;)t(0);for(var i=this.firstOldObject,r=0;i;)s=i.writeTo(e,s,this),i=i.nextObject,r++;if(s!==e.byteLength)throw Error("wrong image size");if(r!==this.oldSpaceCount)throw Error("wrong object count");return e.buffer},objectToOop:function(t){if("number"==typeof t)return t<<1|1;if(t.oop<0)throw Error("temporary oop");return t.oop},bytesLeft:function(){return this.totalMemory-this.oldSpaceBytes},formatVersion:function(){return this.isSpur?6521:this.hasClosures?6504:6502},segmentVersion:function(){var t=this.specialObjectsArray.pointers[Squeak.splOb_SelectorDoesNotUnderstand],e=new Uint32Array(t.bytes.buffer,0,1);return this.formatVersion()|4278190080&e[0]},loadImageSegment:function(t,e){function r(){var t=n.getUint32(a,i);return a+=4,t}function s(t,e){if(e<5){for(var s=[];s.length<t;)s.push(r());return s}var i=new Uint32Array(n.buffer,a,t);return a+=4*t,i}var n=new DataView(t.words.buffer),i=!1,a=0,o=r();if(!0&o&&(i=!0,!(a=0)&(o=r())))return console.error("image segment format not supported"),null;this.tenureIfYoung(t);for(var h=t,c=h.nextObject,u=t.oop,l={},p={};a<n.byteLength;){var m=0,d=0,f=r();switch(f&Squeak.HeaderTypeMask){case Squeak.HeaderTypeSizeAndClass:m=f>>>2,d=r(),f=r();break;case Squeak.HeaderTypeClass:d=f-Squeak.HeaderTypeClass,m=(f=r())>>>2&63;break;case Squeak.HeaderTypeShort:m=f>>>2&63,d=f>>>12&31;break;case Squeak.HeaderTypeFree:throw Error("Unexpected free block")}var v=a,k=f>>>8&15,b=f>>>17&4095,S=s(--m,k),g=new Squeak.Object;g.initFromImage(v+u,d,k,b),h.nextObject=g,this.oldSpaceCount++,h=g,l[v]=g,p[v+u]=S}g.nextObject=c;for(var C=0;C<e.pointers.length;C++)l[2147483652+4*C]=e.pointers[C];var O=this.specialObjectsArray.pointers[Squeak.splOb_CompactClasses].pointers,P=0,I=O.map(function(t){return l[--P]=t,P});t.words=new Uint32Array([t.words[0]]);for(var y=t.nextObject,x=this.specialObjectsArray.pointers[Squeak.splOb_ClassFloat],q=y;q.installFromImage(l,p,I,x,i,!1),(q=q.nextObject)!==c;);return y}},"spur support",{initSpurOverrides:function(){this.registerObject=this.registerObjectSpur,this.writeToBuffer=this.writeToBufferSpur},spurClassTable:function(t,e,s,i){for(var r={},n=this.firstOldObject,a=0;a<4096;a++){var o=t[s[a]];if(o.oop&&(o=e[o.oop]),1024===o.length)for(var h=0;h<1024;h++){var c=t[o[h]];if(!c)throw Error("Invalid class table entry (oop "+o[h]+")");if(c!==n)r[l=1024*a+h]=c}}for(var u in Squeak)if(/^splOb_Class/.test(u)){var l,p=t[e[i.oop][Squeak[u]]];if(p!==n)0<(l=p.hash)&&l<1024&&(r[l]=p)}return r[3]=r[1],this.classTable=r,this.classTableIndex=1024,r},enterIntoClassTable:function(t){for(var e=this.classTableIndex,s=this.classTable;e<=4194303;){if(!s[e])return(s[e]=t).hash=e,this.classTableIndex=e;e++}return console.error("class table full?"),null},initCharacterTable:function(t){t.classInstProto("Character"),this.characterClass=t,this.characterTable={}},getCharacter:function(t){var e=this.characterTable[t];return e||((e=new this.characterClass.instProto).initInstanceOfChar(this.characterClass,t),this.characterTable[t]=e),e},ensureClassesInTable:function(){for(var t=this.firstOldObject,e=1024;t;){var s=t.sqClass;if(0===s.hash&&this.enterIntoClassTable(s),s.hash>e&&(e=s.hash),this.classTable[s.hash]!==s)throw Error("Class not in class table");t=t.nextObject}return 1+(e>>10)},classTableBytes:function(t){return 4*(4108+1028*t)},writeFreeLists:function(t,e,s,i){return t.setUint32(e,167772178,s),e+=4,t.setUint32(e,536870912,s),e+=4,e+=128},writeClassTable:function(t,e,s,i,r){t.setUint32(e,4104,s),e+=4,t.setUint32(e,4278190080,s),e+=4,t.setUint32(e,33554448,s),e+=4,t.setUint32(e,4278190080,s),e+=4;for(var n=0;n<r;n++)t.setUint32(e,16624+4112*n,s),e+=4;e+=4*(4104-r);var a=0;for(n=0;n<r;n++){t.setUint32(e,1024,s),e+=4,t.setUint32(e,4278190080,s),e+=4,t.setUint32(e,33554448,s),e+=4,t.setUint32(e,4278190080,s),e+=4;for(var o=0;o<1024;o++){var h=this.classTable[a];if(h&&h.pointers){if(!h.hash)throw Error("class without id");h.hash!==a&&32<=a&&(console.warn("freeing class index "+a+" "+h.className()),h=null)}h&&t.setUint32(e,i(h),s),e+=4,a++}}return e},writeToBufferSpur:function(){var t=this.ensureClassesInTable(),e=136+this.classTableBytes(t),s=new DataView(new ArrayBuffer(64+e+this.oldSpaceBytes+16)),i=!0,r=Date.now(),n=0;function a(t){s.setUint32(n,t,i),n+=4}function o(t){if("number"==typeof t)return t<<1|1;if(7===t._format){if(t.hash!==t.oop>>2||2!=(3&t.oop))throw Error("Bad immediate char");return t.oop}if(t.oop<0)throw Error("temporary oop");return t.oop<48?t.oop:t.oop+e}for(a(this.formatVersion()),a(64),a(e+this.oldSpaceBytes+16),a(this.firstOldObject.addr()),a(o(this.specialObjectsArray)),a(this.lastHash),this.savedHeaderWords.forEach(a),a(e+this.oldSpaceBytes+16);n<64;)a(0);var h=this.firstOldObject,c=0;for(n=h.writeTo(s,n,i,o),h=h.nextObject,c++,n=h.writeTo(s,n,i,o),h=h.nextObject,c++,n=h.writeTo(s,n,i,o),h=h.nextObject,c++,n=this.writeFreeLists(s,n,i,o),n=this.writeClassTable(s,n,i,o,t);h;)n=h.writeTo(s,n,i,o),h=h.nextObject,c++;if(a(1241513987),a(8388608),a(0),a(0),n!==s.byteLength)throw Error("wrong image size");if(c!==this.oldSpaceCount)throw Error("wrong object count");var u=Date.now()-r;return console.log("Wrote "+c+" objects in "+u+" ms, image size "+n+" bytes"),s.buffer}}),Object.subclass("Squeak.Interpreter","initialization",{initialize:function(t,e){console.log("squeak: initializing interpreter "+Squeak.vmVersion),this.Squeak=Squeak,this.image=t,(this.image.vm=this).primHandler=new Squeak.Primitives(this,e),this.loadImageState(),this.hackImage(),this.initVMState(),this.loadInitialContext(),this.initCompiler(),console.log("squeak: ready")},loadImageState:function(){this.specialObjects=this.image.specialObjectsArray.pointers,this.specialSelectors=this.specialObjects[Squeak.splOb_SpecialSelectors].pointers,this.nilObj=this.specialObjects[Squeak.splOb_NilObject],this.falseObj=this.specialObjects[Squeak.splOb_FalseObject],this.trueObj=this.specialObjects[Squeak.splOb_TrueObject],this.hasClosures=this.image.hasClosures,this.globals=this.findGlobals(),this.hasClosures||this.findMethod("UnixFileDirectory class>>pathNameDelimiter")||(this.primHandler.emulateMac=!0),6501==this.image.version&&(this.primHandler.reverseDisplay=!0)},initVMState:function(){this.byteCodeCount=0,this.sendCount=0,this.interruptCheckCounter=0,this.interruptCheckCounterFeedBackReset=1e3,this.interruptChecksEveryNms=3,this.nextPollTick=0,this.nextWakeupTick=0,this.lastTick=0,this.interruptKeycode=2094,this.interruptPending=!1,this.pendingFinalizationSignals=0,this.freeContexts=this.nilObj,this.freeLargeContexts=this.nilObj,this.reclaimableContextCount=0,this.nRecycledContexts=0,this.nAllocatedContexts=0,this.methodCacheSize=1024,this.methodCacheMask=this.methodCacheSize-1,this.methodCacheRandomish=0,this.methodCache=[];for(var t=0;t<this.methodCacheSize;t++)this.methodCache[t]={lkupClass:null,selector:null,method:null,primIndex:0,argCount:0,mClass:null};this.breakOutOfInterpreter=!1,this.breakOutTick=0,this.breakOnMethod=null,this.breakOnNewMethod=!1,this.breakOnContextChanged=!1,this.breakOnContextReturned=null,this.messages={},this.startupTime=Date.now()},loadInitialContext:function(){var t=this.specialObjects[Squeak.splOb_SchedulerAssociation].pointers[Squeak.Assn_value].pointers[Squeak.ProcSched_activeProcess];this.activeContext=t.pointers[Squeak.Proc_suspendedContext],this.activeContext.dirty=!0,this.fetchContextRegisters(this.activeContext),this.reclaimableContextCount=0},findGlobals:function(){var t=this.specialObjects[Squeak.splOb_SmalltalkDictionary],e=t.sqClass.className();if("Association"===e&&(e=(t=t.pointers[1]).sqClass.className()),"SystemDictionary"===e)return t.pointers[1].pointers;if("SmalltalkImage"===e){var s=t.pointers[0],i=s.sqClass.className();if("SystemDictionary"===i)return s.pointers[1].pointers;if("Environment"===i)return s.pointers[2].pointers[1].pointers}return console.warn("cannot find global dict"),[]},initCompiler:function(){if(!Squeak.Compiler)return console.warn("Squeak.Compiler not loaded, using interpreter only");try{if(42!==new Function("return 42")())return console.warn("function constructor not working, disabling JIT")}catch(t){return console.warn("disabling JIT: "+t)}var t=this.image.oldSpaceCount/(this.startupTime-this.image.startupTime);if(t<10)return console.warn("Slow machine detected (loaded "+(1e3*t|0)+" objects/sec), using interpreter only");try{console.log("squeak: initializing JIT compiler"),this.compiler=new Squeak.Compiler(this)}catch(t){console.warn("Compiler "+t)}},hackImage:function(){[].forEach(function(t){var e=this.findMethod(t.method);e&&(e.pointers[0]|=t.primitive,console.warn("Hacking "+t.method))},this),this.findMethod("PharoClassInstaller>>initialize")&&(Squeak.platformName="unix")}},"interpreting",{interpretOne:function(t){if(!this.method.compiled){var e,s,i=this.Squeak;if(this.byteCodeCount++,(e=this.nextByte())<128)switch(e){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:case 10:case 11:case 12:case 13:case 14:case 15:return void this.push(this.receiver.pointers[15&e]);case 16:case 17:case 18:case 19:case 20:case 21:case 22:case 23:case 24:case 25:case 26:case 27:case 28:case 29:case 30:case 31:return void this.push(this.homeContext.pointers[i.Context_tempFrameStart+(15&e)]);case 32:case 33:case 34:case 35:case 36:case 37:case 38:case 39:case 40:case 41:case 42:case 43:case 44:case 45:case 46:case 47:case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:case 58:case 59:case 60:case 61:case 62:case 63:return void this.push(this.method.methodGetLiteral(31&e));case 64:case 65:case 66:case 67:case 68:case 69:case 70:case 71:case 72:case 73:case 74:case 75:case 76:case 77:case 78:case 79:case 80:case 81:case 82:case 83:case 84:case 85:case 86:case 87:case 88:case 89:case 90:case 91:case 92:case 93:case 94:case 95:return void this.push(this.method.methodGetLiteral(31&e).pointers[i.Assn_value]);case 96:case 97:case 98:case 99:case 100:case 101:case 102:case 103:return this.receiver.dirty=!0,void(this.receiver.pointers[7&e]=this.pop());case 104:case 105:case 106:case 107:case 108:case 109:case 110:case 111:return void(this.homeContext.pointers[i.Context_tempFrameStart+(7&e)]=this.pop());case 112:return void this.push(this.receiver);case 113:return void this.push(this.trueObj);case 114:return void this.push(this.falseObj);case 115:return void this.push(this.nilObj);case 116:return void this.push(-1);case 117:return void this.push(0);case 118:return void this.push(1);case 119:return void this.push(2);case 120:return void this.doReturn(this.receiver);case 121:return void this.doReturn(this.trueObj);case 122:return void this.doReturn(this.falseObj);case 123:return void this.doReturn(this.nilObj);case 124:return void this.doReturn(this.pop());case 125:return void this.doReturn(this.pop(),this.activeContext.pointers[i.BlockContext_caller]);case 126:case 127:return void this.nono()}else switch(e){case 128:return void this.extendedPush(this.nextByte());case 129:return void this.extendedStore(this.nextByte());case 130:return void this.extendedStorePop(this.nextByte());case 131:return s=this.nextByte(),void this.send(this.method.methodGetSelector(31&s),s>>5,!1);case 132:return void this.doubleExtendedDoAnything(this.nextByte());case 133:return s=this.nextByte(),void this.send(this.method.methodGetSelector(31&s),s>>5,!0);case 134:return s=this.nextByte(),void this.send(this.method.methodGetSelector(63&s),s>>6,!1);case 135:return void this.pop();case 136:return void this.push(this.top());case 137:return void this.push(this.exportThisContext());case 138:return void this.pushNewArray(this.nextByte());case 139:return void this.callPrimBytecode();case 140:return s=this.nextByte(),void this.push(this.homeContext.pointers[i.Context_tempFrameStart+this.nextByte()].pointers[s]);case 141:return s=this.nextByte(),void(this.homeContext.pointers[i.Context_tempFrameStart+this.nextByte()].pointers[s]=this.top());case 142:return s=this.nextByte(),void(this.homeContext.pointers[i.Context_tempFrameStart+this.nextByte()].pointers[s]=this.pop());case 143:return void this.pushClosureCopy();case 144:case 145:case 146:case 147:case 148:case 149:case 150:case 151:return void(this.pc+=1+(7&e));case 152:case 153:case 154:case 155:case 156:case 157:case 158:case 159:return void this.jumpIfFalse(1+(7&e));case 160:case 161:case 162:case 163:case 164:case 165:case 166:case 167:return s=this.nextByte(),this.pc+=256*((7&e)-4)+s,void((7&e)<4&&this.interruptCheckCounter--<=0&&this.checkForInterrupts());case 168:case 169:case 170:case 171:return void this.jumpIfTrue(256*(3&e)+this.nextByte());case 172:case 173:case 174:case 175:return void this.jumpIfFalse(256*(3&e)+this.nextByte());case 176:return this.success=!0,this.resultIsFloat=!1,void(this.pop2AndPushNumResult(this.stackIntOrFloat(1)+this.stackIntOrFloat(0))||this.sendSpecial(15&e));case 177:return this.success=!0,this.resultIsFloat=!1,void(this.pop2AndPushNumResult(this.stackIntOrFloat(1)-this.stackIntOrFloat(0))||this.sendSpecial(15&e));case 178:return this.success=!0,void(this.pop2AndPushBoolResult(this.stackIntOrFloat(1)<this.stackIntOrFloat(0))||this.sendSpecial(15&e));case 179:return this.success=!0,void(this.pop2AndPushBoolResult(this.stackIntOrFloat(1)>this.stackIntOrFloat(0))||this.sendSpecial(15&e));case 180:return this.success=!0,void(this.pop2AndPushBoolResult(this.stackIntOrFloat(1)<=this.stackIntOrFloat(0))||this.sendSpecial(15&e));case 181:return this.success=!0,void(this.pop2AndPushBoolResult(this.stackIntOrFloat(1)>=this.stackIntOrFloat(0))||this.sendSpecial(15&e));case 182:return this.success=!0,void(this.pop2AndPushBoolResult(this.stackIntOrFloat(1)===this.stackIntOrFloat(0))||this.sendSpecial(15&e));case 183:return this.success=!0,void(this.pop2AndPushBoolResult(this.stackIntOrFloat(1)!==this.stackIntOrFloat(0))||this.sendSpecial(15&e));case 184:return this.success=!0,this.resultIsFloat=!1,void(this.pop2AndPushNumResult(this.stackIntOrFloat(1)*this.stackIntOrFloat(0))||this.sendSpecial(15&e));case 185:return this.success=!0,void(this.pop2AndPushIntResult(this.quickDivide(this.stackInteger(1),this.stackInteger(0)))||this.sendSpecial(15&e));case 186:return this.success=!0,void(this.pop2AndPushIntResult(this.mod(this.stackInteger(1),this.stackInteger(0)))||this.sendSpecial(15&e));case 187:return this.success=!0,void(this.primHandler.primitiveMakePoint(1,!0)||this.sendSpecial(15&e));case 188:return this.success=!0,void(this.pop2AndPushIntResult(this.safeShift(this.stackInteger(1),this.stackInteger(0)))||this.sendSpecial(15&e));case 189:return this.success=!0,void(this.pop2AndPushIntResult(this.div(this.stackInteger(1),this.stackInteger(0)))||this.sendSpecial(15&e));case 190:return this.success=!0,void(this.pop2AndPushIntResult(this.stackInteger(1)&this.stackInteger(0))||this.sendSpecial(15&e));case 191:return this.success=!0,void(this.pop2AndPushIntResult(this.stackInteger(1)|this.stackInteger(0))||this.sendSpecial(15&e));case 192:case 193:case 194:case 195:case 196:case 197:case 198:case 199:case 200:case 201:case 202:case 203:case 204:case 205:case 206:case 207:return void(this.primHandler.quickSendOther(this.receiver,15&e)||this.sendSpecial(16+(15&e)));case 208:case 209:case 210:case 211:case 212:case 213:case 214:case 215:case 216:case 217:case 218:case 219:case 220:case 221:case 222:case 223:return void this.send(this.method.methodGetSelector(15&e),0,!1);case 224:case 225:case 226:case 227:case 228:case 229:case 230:case 231:case 232:case 233:case 234:case 235:case 236:case 237:case 238:case 239:return void this.send(this.method.methodGetSelector(15&e),1,!1);case 240:case 241:case 242:case 243:case 244:case 245:case 246:case 247:case 248:case 249:case 250:case 251:case 252:case 253:case 254:case 255:return void this.send(this.method.methodGetSelector(15&e),2,!1)}throw Error("not a bytecode: "+e)}if(t){if(!this.compiler.enableSingleStepping(this.method))return this.method.compiled=null,this.interpretOne(t);this.breakNow()}this.method.compiled(this)},interpret:function(t,e){if(this.frozen)return"frozen";for(this.isIdle=!1,this.breakOutOfInterpreter=!1,this.breakOutTick=this.primHandler.millisecondClockValue()+(t||500);!1===this.breakOutOfInterpreter;)this.method.compiled?this.method.compiled(this):this.interpretOne();if("function"==typeof this.breakOutOfInterpreter)return this.breakOutOfInterpreter(e);var s="break"==this.breakOutOfInterpreter?"break":this.isIdle?this.nextWakeupTick?Math.max(1,this.nextWakeupTick-this.primHandler.millisecondClockValue()):"sleep":0;return e&&e(s),s},goIdle:function(){var t=0!==this.nextWakeupTick;this.forceInterruptCheck(),this.checkForInterrupts();var e=0!==this.nextWakeupTick;this.isIdle=e||!t,this.breakOut()},freeze:function(t){var e;this.frozen=!0,this.breakOutOfInterpreter=function(t){if(!t)throw Error("need function to restart interpreter");return e=t,"frozen"}.bind(this);var s=function(){if(this.frozen=!1,!e)throw Error("no continue function");e(0)}.bind(this);return t&&self.setTimeout(function(){t(s)},0),s},breakOut:function(){this.breakOutOfInterpreter=this.breakOutOfInterpreter||!0},nextByte:function(){return this.method.bytes[this.pc++]},nono:function(){throw Error("Oh No!")},forceInterruptCheck:function(){this.interruptCheckCounter=-1e3},checkForInterrupts:function(){var t=this.primHandler.millisecondClockValue();t<this.lastTick&&(this.nextPollTick=t+(this.nextPollTick-this.lastTick),this.breakOutTick=t+(this.breakOutTick-this.lastTick),0!==this.nextWakeupTick&&(this.nextWakeupTick=t+(this.nextWakeupTick-this.lastTick))),-100<this.interruptCheckCounter&&(t-this.lastTick<this.interruptChecksEveryNms?this.interruptCheckCounterFeedBackReset+=10:this.interruptCheckCounterFeedBackReset<=1e3?this.interruptCheckCounterFeedBackReset=1e3:this.interruptCheckCounterFeedBackReset-=12),this.interruptCheckCounter=this.interruptCheckCounterFeedBackReset,this.lastTick=t,this.interruptPending&&(this.interruptPending=!1,(e=this.specialObjects[Squeak.splOb_TheInterruptSemaphore]).isNil||this.primHandler.synchronousSignal(e));0!==this.nextWakeupTick&&t>=this.nextWakeupTick&&(this.nextWakeupTick=0,(e=this.specialObjects[Squeak.splOb_TheTimerSemaphore]).isNil||this.primHandler.synchronousSignal(e));if(0<this.pendingFinalizationSignals){var e=this.specialObjects[Squeak.splOb_TheFinalizationSemaphore];this.pendingFinalizationSignals=0,e.isNil||this.primHandler.synchronousSignal(e)}0<this.primHandler.semaphoresToSignal.length&&this.primHandler.signalExternalSemaphores(),!this.method.compiled&&this.compiler&&this.compiler.compile(this.method),t>=this.breakOutTick&&this.breakOut()},extendedPush:function(t){var e=63&t;switch(t>>6){case 0:this.push(this.receiver.pointers[e]);break;case 1:this.push(this.homeContext.pointers[Squeak.Context_tempFrameStart+e]);break;case 2:this.push(this.method.methodGetLiteral(e));break;case 3:this.push(this.method.methodGetLiteral(e).pointers[Squeak.Assn_value])}},extendedStore:function(t){var e=63&t;switch(t>>6){case 0:this.receiver.dirty=!0,this.receiver.pointers[e]=this.top();break;case 1:this.homeContext.pointers[Squeak.Context_tempFrameStart+e]=this.top();break;case 2:this.nono();break;case 3:var s=this.method.methodGetLiteral(e);s.dirty=!0,s.pointers[Squeak.Assn_value]=this.top()}},extendedStorePop:function(t){var e=63&t;switch(t>>6){case 0:this.receiver.dirty=!0,this.receiver.pointers[e]=this.pop();break;case 1:this.homeContext.pointers[Squeak.Context_tempFrameStart+e]=this.pop();break;case 2:this.nono();break;case 3:var s=this.method.methodGetLiteral(e);s.dirty=!0,s.pointers[Squeak.Assn_value]=this.pop()}},doubleExtendedDoAnything:function(t){var e=this.nextByte();switch(t>>5){case 0:this.send(this.method.methodGetSelector(e),31&t,!1);break;case 1:this.send(this.method.methodGetSelector(e),31&t,!0);break;case 2:this.push(this.receiver.pointers[e]);break;case 3:this.push(this.method.methodGetLiteral(e));break;case 4:this.push(this.method.methodGetLiteral(e).pointers[Squeak.Assn_value]);break;case 5:this.receiver.dirty=!0,this.receiver.pointers[e]=this.top();break;case 6:this.receiver.dirty=!0,this.receiver.pointers[e]=this.pop();break;case 7:var s=this.method.methodGetLiteral(e);s.dirty=!0,s.pointers[Squeak.Assn_value]=this.top()}},jumpIfTrue:function(t){var e=this.pop();e.isTrue?this.pc+=t:e.isFalse||(this.push(e),this.send(this.specialObjects[Squeak.splOb_SelectorMustBeBoolean],0,!1))},jumpIfFalse:function(t){var e=this.pop();e.isFalse?this.pc+=t:e.isTrue||(this.push(e),this.send(this.specialObjects[Squeak.splOb_SelectorMustBeBoolean],0,!1))},sendSpecial:function(t){this.send(this.specialSelectors[2*t],this.specialSelectors[2*t+1],!1)},callPrimBytecode:function(){this.pc+=2,this.primFailCode&&(129===this.method.bytes[this.pc]&&this.stackTopPut(this.getErrorObjectFromPrimFailCode()),this.primFailCode=0)},getErrorObjectFromPrimFailCode:function(){var t=this.specialObjects[Squeak.splOb_PrimErrTableIndex];if(t&&t.pointers){var e=t.pointers[this.primFailCode-1];if(e)return e}return this.primFailCode}},"closures",{pushNewArray:function(t){var e=127<t,s=127&t,i=this.instantiateClass(this.specialObjects[Squeak.splOb_ClassArray],s);if(e){for(var r=0;r<s;r++)i.pointers[r]=this.stackValue(s-r-1);this.popN(s)}this.push(i)},pushClosureCopy:function(){var t=this.nextByte(),e=15&t,s=t>>4,i=256*this.nextByte()+this.nextByte(),r=this.encodeSqueakPC(this.pc,this.method),n=this.newClosure(e,r,s);if(n.pointers[Squeak.Closure_outerContext]=this.activeContext,(this.reclaimableContextCount=0)<s){for(var a=0;a<s;a++)n.pointers[Squeak.Closure_firstCopiedValue+a]=this.stackValue(s-a-1);this.popN(s)}this.pc+=i,this.push(n)},newClosure:function(t,e,s){var i=this.instantiateClass(this.specialObjects[Squeak.splOb_ClassBlockClosure],s);return i.pointers[Squeak.Closure_startpc]=e,i.pointers[Squeak.Closure_numArgs]=t,i}},"sending",{send:function(t,e,s){var i=this.stackValue(e),r=this.getClass(i);s&&(r=(r=this.method.methodClassForSuper()).pointers[Squeak.Class_superclass]);var n=this.findSelectorInClass(t,e,r);n.primIndex&&(this.verifyAtSelector=t,this.verifyAtClass=r),this.executeNewMethod(i,n.method,n.argCount,n.primIndex,n.mClass,t)},sendAsPrimitiveFailure:function(t,e,s){this.executeNewMethod(t,e,s,0)},findSelectorInClass:function(t,e,s){var i=this.findMethodCacheEntry(t,s);if(i.method)return i;for(var r,n=s;!n.isNil;){if((r=n.pointers[Squeak.Class_mdict]).isNil){var a=this.specialObjects[Squeak.splOb_SelectorCannotInterpret],o=this.createActualMessage(t,e,s);return this.popNandPush(e,o),this.findSelectorInClass(a,1,n.superclass())}var h=this.lookupSelectorInDict(r,t);if(!h.isNil)return this.currentSelector=t,this.currentLookupClass=s,i.method=h,i.primIndex=h.isMethod()?h.methodPrimitiveIndex():248,i.argCount=e,i.mClass=n,i;n=n.superclass()}var c=this.specialObjects[Squeak.splOb_SelectorDoesNotUnderstand];if(t===c)throw Error("Recursive not understood error encountered");var u=this.createActualMessage(t,e,s);return this.popNandPush(e,u),this.findSelectorInClass(c,1,s)},lookupSelectorInDict:function(t,e){for(var s=t.pointersSize(),i=(s-Squeak.MethodDict_selectorStart-1&e.hash)+Squeak.MethodDict_selectorStart,r=!1;;){var n=t.pointers[i];if(n===e)return t.pointers[Squeak.MethodDict_array].pointers[i-Squeak.MethodDict_selectorStart];if(n.isNil)return this.nilObj;if(++i===s){if(r)return this.nilObj;i=Squeak.MethodDict_selectorStart,r=!0}}},executeNewMethod:function(t,e,s,i,r,n){if(this.sendCount++,e===this.breakOnMethod&&this.breakNow("executing method "+this.printMethod(e,r,n)),this.logSends&&console.log(this.sendCount+" "+this.printMethod(e,r,n)),this.breakOnContextChanged&&(this.breakOnContextChanged=!1,this.breakNow()),!(0<i&&this.tryPrimitive(i,s,e))){var a=this.allocateOrRecycleContext(e.methodNeedsLargeFrame()),o=e.methodTempCount(),h=Squeak.Context_tempFrameStart+o-1;if(a.pointers[Squeak.Context_method]=e,a.pointers[Squeak.BlockContext_initialIP]=this.nilObj,a.pointers[Squeak.Context_sender]=this.activeContext,this.arrayCopy(this.activeContext.pointers,this.sp-s,a.pointers,Squeak.Context_tempFrameStart-1,s+1),this.arrayFill(a.pointers,Squeak.Context_tempFrameStart+s,Squeak.Context_tempFrameStart+o,this.nilObj),this.popN(s+1),this.reclaimableContextCount++,this.storeContextRegisters(),this.activeContext=a,this.activeContext.dirty=!0,this.homeContext=a,this.method=e,this.pc=0,this.sp=h,this.receiver=a.pointers[Squeak.Context_receiver],this.receiver!==t)throw Error("receivers don't match");!e.compiled&&this.compiler&&this.compiler.compile(e,r,n),this.interruptCheckCounter--<=0&&this.checkForInterrupts()}},doReturn:function(t,e){if(!e){var s=this.homeContext;if(this.hasClosures)for(var i;!(i=s.pointers[Squeak.Context_closure]).isNil;)s=i.pointers[Squeak.Closure_outerContext];e=s.pointers[Squeak.Context_sender]}if(e.isNil||e.pointers[Squeak.Context_instructionPointer].isNil)return this.cannotReturn(t);for(var r,n=this.activeContext.pointers[Squeak.Context_sender];n!==e;){if(n.isNil)return this.cannotReturn(t);if(this.isUnwindMarked(n))return this.aboutToReturnThrough(t,n);n=n.pointers[Squeak.Context_sender]}for(n=this.activeContext;n!==e;)this.breakOnContextReturned===n&&(this.breakOnContextReturned=null,this.breakNow()),r=n.pointers[Squeak.Context_sender],n.pointers[Squeak.Context_sender]=this.nilObj,n.pointers[Squeak.Context_instructionPointer]=this.nilObj,0<this.reclaimableContextCount&&(this.reclaimableContextCount--,this.recycleIfPossible(n)),n=r;this.activeContext=n,this.activeContext.dirty=!0,this.fetchContextRegisters(this.activeContext),this.push(t),this.breakOnContextChanged&&(this.breakOnContextChanged=!1,this.breakNow())},aboutToReturnThrough:function(t,e){this.push(this.exportThisContext()),this.push(t),this.push(e);var s=this.specialObjects[Squeak.splOb_SelectorAboutToReturn];this.send(s,2)},cannotReturn:function(t){this.push(this.exportThisContext()),this.push(t);var e=this.specialObjects[Squeak.splOb_SelectorCannotReturn];this.send(e,1)},tryPrimitive:function(t,e,s){if(255<t&&t<520){if(264<=t)return this.popNandPush(1,this.top().pointers[t-264]),!0;switch(t){case 256:return!0;case 257:return this.popNandPush(1,this.trueObj),!0;case 258:return this.popNandPush(1,this.falseObj),!0;case 259:return this.popNandPush(1,this.nilObj),!0}return this.popNandPush(1,t-261),!0}return this.primHandler.doPrimitive(t,e,s)},createActualMessage:function(t,e,s){var i=this.instantiateClass(this.specialObjects[Squeak.splOb_ClassMessage],0),r=this.instantiateClass(this.specialObjects[Squeak.splOb_ClassArray],e);return this.arrayCopy(this.activeContext.pointers,this.sp-e+1,r.pointers,0,e),i.pointers[Squeak.Message_selector]=t,i.pointers[Squeak.Message_arguments]=r,i.pointers.length>Squeak.Message_lookupClass&&(i.pointers[Squeak.Message_lookupClass]=s),i},primitivePerform:function(t){var e=this.stackValue(t-1),s=this.stackValue(t),i=t-1,r=this.sp-i,n=this.activeContext.pointers;this.arrayCopy(n,1+r,n,r,i),this.sp--;var a=this.findSelectorInClass(e,i,this.getClass(s));return this.executeNewMethod(s,a.method,a.argCount,a.primIndex,a.mClass,e),!0},primitivePerformWithArgs:function(t,e){var s=e?3:2,i=this.stackValue(s),r=this.stackValue(s-1),n=this.stackValue(s-2);if(n.sqClass!==this.specialObjects[Squeak.splOb_ClassArray])return!1;var a=e?this.top():this.getClass(i);if(e)for(var o=this.getClass(i);o!==a;)if((o=o.pointers[Squeak.Class_superclass]).isNil)return!1;var h=n.pointersSize(),c=this.sp-(s-1),u=this.activeContext.pointers;this.arrayCopy(n.pointers,0,u,c,h),this.sp+=h-t;var l=this.findSelectorInClass(r,h,a);return this.executeNewMethod(i,l.method,l.argCount,l.primIndex,l.mClass,r),!0},primitiveInvokeObjectAsMethod:function(t,e){for(var s=this.instantiateClass(this.specialObjects[Squeak.splOb_ClassArray],t),i=0;i<t;i++)s.pointers[t-i-1]=this.pop();var r=this.pop(),n=this.currentSelector,a=this.specialObjects[Squeak.splOb_SelectorRunWithIn];return this.push(e),this.push(n),this.push(s),this.push(r),this.send(a,3,!1),!0},findMethodCacheEntry:function(t,e){var s;this.methodCacheRandomish=this.methodCacheRandomish+1&3;for(var i=(t.hash^e.hash)&this.methodCacheMask,r=i,n=0;n<4;n++){if((s=this.methodCache[r]).selector===t&&s.lkupClass===e)return s;n===this.methodCacheRandomish&&(i=r),r=r+t.hash&this.methodCacheMask}return(s=this.methodCache[i]).lkupClass=e,s.selector=t,s.method=null,s},flushMethodCache:function(){for(var t=0;t<this.methodCacheSize;t++)this.methodCache[t].selector=null,this.methodCache[t].method=null;return!0},flushMethodCacheForSelector:function(t){for(var e=0;e<this.methodCacheSize;e++)this.methodCache[e].selector===t&&(this.methodCache[e].selector=null,this.methodCache[e].method=null);return!0},flushMethodCacheForMethod:function(t){for(var e=0;e<this.methodCacheSize;e++)this.methodCache[e].method===t&&(this.methodCache[e].selector=null,this.methodCache[e].method=null);return!0},flushMethodCacheAfterBecome:function(t){this.flushMethodCache()}},"contexts",{isUnwindMarked:function(t){return!!this.isMethodContext(t)&&198==t.pointers[Squeak.Context_method].methodPrimitiveIndex()},newActiveContext:function(t){this.storeContextRegisters(),this.activeContext=t,this.activeContext.dirty=!0,this.fetchContextRegisters(t)},exportThisContext:function(){return this.storeContextRegisters(),this.reclaimableContextCount=0,this.activeContext},fetchContextRegisters:function(t){var e=t.pointers[Squeak.Context_method];this.isSmallInt(e)?(this.homeContext=t.pointers[Squeak.BlockContext_home],e=this.homeContext.pointers[Squeak.Context_method]):this.homeContext=t,this.receiver=this.homeContext.pointers[Squeak.Context_receiver],this.method=e,this.pc=this.decodeSqueakPC(t.pointers[Squeak.Context_instructionPointer],e),this.sp=this.decodeSqueakSP(t.pointers[Squeak.Context_stackPointer])},storeContextRegisters:function(){this.activeContext.pointers[Squeak.Context_instructionPointer]=this.encodeSqueakPC(this.pc,this.method),this.activeContext.pointers[Squeak.Context_stackPointer]=this.encodeSqueakSP(this.sp)},encodeSqueakPC:function(t,e){return t+4*e.pointers.length+1},decodeSqueakPC:function(t,e){return t-4*e.pointers.length-1},encodeSqueakSP:function(t){return t-(Squeak.Context_tempFrameStart-1)},decodeSqueakSP:function(t){return t+(Squeak.Context_tempFrameStart-1)},recycleIfPossible:function(t){if(this.isMethodContext(t))if(t.pointersSize()===Squeak.Context_tempFrameStart+Squeak.Context_smallFrameSize)t.pointers[0]=this.freeContexts,this.freeContexts=t;else{if(t.pointersSize()!==Squeak.Context_tempFrameStart+Squeak.Context_largeFrameSize)return;t.pointers[0]=this.freeLargeContexts,this.freeLargeContexts=t}},allocateOrRecycleContext:function(t){var e;return t?this.freeLargeContexts.isNil?(this.nAllocatedContexts++,this.instantiateClass(this.specialObjects[Squeak.splOb_ClassMethodContext],Squeak.Context_largeFrameSize)):(e=this.freeLargeContexts,this.freeLargeContexts=e.pointers[0],this.nRecycledContexts++,e):this.freeContexts.isNil?(this.nAllocatedContexts++,this.instantiateClass(this.specialObjects[Squeak.splOb_ClassMethodContext],Squeak.Context_smallFrameSize)):(e=this.freeContexts,this.freeContexts=e.pointers[0],this.nRecycledContexts++,e)}},"stack access",{pop:function(){return this.activeContext.pointers[this.sp--]},popN:function(t){this.sp-=t},push:function(t){this.activeContext.pointers[++this.sp]=t},popNandPush:function(t,e){this.activeContext.pointers[this.sp-=t-1]=e},top:function(){return this.activeContext.pointers[this.sp]},stackTopPut:function(t){this.activeContext.pointers[this.sp]=t},stackValue:function(t){return this.activeContext.pointers[this.sp-t]},stackInteger:function(t){return this.checkSmallInt(this.stackValue(t))},stackIntOrFloat:function(t){var e=this.stackValue(t);if("number"==typeof e)return e;if(e.isFloat)return this.resultIsFloat=!0,e.float;var s=e.bytes;if(s&&4==s.length){for(var i=0,r=3;0<=r;r--)i=256*i+s[r];if(e.sqClass===this.specialObjects[Squeak.splOb_ClassLargePositiveInteger])return i;if(e.sqClass===this.specialObjects[Squeak.splOb_ClassLargeNegativeInteger])return-i}return this.success=!1,0},pop2AndPushIntResult:function(t){return!(!this.success||!this.canBeSmallInt(t))&&(this.popNandPush(2,t),!0)},pop2AndPushNumResult:function(t){if(this.success){if(this.resultIsFloat)return this.popNandPush(2,this.primHandler.makeFloat(t)),!0;if(t>=Squeak.MinSmallInt&&t<=Squeak.MaxSmallInt)return this.popNandPush(2,t),!0;if(-4294967295<=t&&t<=4294967295){var e=t<0,s=e?-t:t,i=e?Squeak.splOb_ClassLargeNegativeInteger:Squeak.splOb_ClassLargePositiveInteger,r=this.instantiateClass(this.specialObjects[i],4),n=r.bytes;return n[0]=255&s,n[1]=s>>8&255,n[2]=s>>16&255,n[3]=s>>24&255,this.popNandPush(2,r),!0}}return!1},pop2AndPushBoolResult:function(t){return!!this.success&&(this.popNandPush(2,t?this.trueObj:this.falseObj),!0)}},"numbers",{getClass:function(t){return this.isSmallInt(t)?this.specialObjects[Squeak.splOb_ClassInteger]:t.sqClass},canBeSmallInt:function(t){return t>=Squeak.MinSmallInt&&t<=Squeak.MaxSmallInt},isSmallInt:function(t){return"number"==typeof t},checkSmallInt:function(t){return"number"==typeof t?t:(this.success=!1,1)},quickDivide:function(t,e){if(0===e)return Squeak.NonSmallInt;var s=t/e|0;return s*e===t?s:Squeak.NonSmallInt},div:function(t,e){return 0===e?Squeak.NonSmallInt:Math.floor(t/e)},mod:function(t,e){return 0===e?Squeak.NonSmallInt:t-Math.floor(t/e)*e},safeShift:function(t,e){if(e<0)return e<-31?t<0?-1:0:t>>-e;if(31<e)return 0==t?0:Squeak.NonSmallInt;var s=t<<e;return s>>e===t?s:Squeak.NonSmallInt}},"utils",{isContext:function(t){return t.sqClass===this.specialObjects[Squeak.splOb_ClassMethodContext]||t.sqClass===this.specialObjects[Squeak.splOb_ClassBlockContext]},isMethodContext:function(t){return t.sqClass===this.specialObjects[Squeak.splOb_ClassMethodContext]},instantiateClass:function(t,e){return this.image.instantiateClass(t,e,this.nilObj)},arrayFill:function(t,e,s,i){for(var r=e;r<s;r++)t[r]=i},arrayCopy:function(t,e,s,i,r){if(t===s&&e<i)for(var n=r-1;0<=n;n--)s[i+n]=t[e+n];else for(n=0;n<r;n++)s[i+n]=t[e+n]}},"debugging",{addMessage:function(t){return this.messages[t]?++this.messages[t]:this.messages[t]=1},warnOnce:function(t){1==this.addMessage(t)&&console.warn(t)},printMethod:function(i,t,e){return e?t.className()+">>"+e.bytesAsString():(i=i||this.activeContext.contextMethod(),this.allMethodsDo(function(t,e,s){if(e===i)return r=t.className()+">>"+s.bytesAsString()}),r||(t?"("+t.pointers[Squeak.Context_receiver]+")>>?":"?>>?"));var r},allInstancesOf:function(t,e){"string"==typeof t&&(t=this.globalNamed(t));for(var s=[],i=this.image.someInstanceOf(t);i;)e?e(i):s.push(i),i=this.image.nextInstanceAfter(i);return s},globalNamed:function(s){return this.allGlobalsDo(function(t,e){if(t.bytesAsString()===s)return e})},allGlobalsDo:function(t){for(var e=this.globals,s=0;s<e.length;s++){var i=e[s];if(!i.isNil){var r=t(i.pointers[0],i.pointers[1]);if(r)return r}}},allMethodsDo:function(c){this.allGlobalsDo(function(t,e){if(e.pointers&&9<=e.pointers.length)for(var s=[e,e.sqClass],i=0;i<s.length;i++){var r=s[i],n=r.pointers[1];if(n.pointers&&n.pointers[1]){var a=n.pointers[1].pointers;if(a)for(var o=n.pointers,h=0;h<a.length;h++)if(!a[h].isNil&&c.call(this,r,a[h],o[2+h]))return!0}}})},printStack:function(t,e){"number"==typeof t&&(e=t,t=null),t=t||this.activeContext,e=e||100;for(var s=[],i=Math.max(e,1e6);!t.isNil&&0<i--;)s.push(t),t=t.pointers[Squeak.Context_sender];s.length>e+200&&(t.isNil||s.push("..."),s=s.slice(0,e).concat(["..."]).concat(s.slice(-200)));for(var r=[],n=s.length;0<n--;){if((t=s[n]).pointers){var a="",o=t.pointers[Squeak.Context_method];"number"==typeof o?(o=t.pointers[Squeak.BlockContext_home].pointers[Squeak.Context_method],a="[] in "):t.pointers[Squeak.Context_closure].isNil||(a="[] in "),r.push(a+this.printMethod(o,t)+"\n")}else r.push("...\n")}return r.join("")},findMethod:function(t){var i,r=t.split(">>")[0],n=t.split(">>")[1];return this.allMethodsDo(function(t,e,s){if(n.length==s.bytesSize()&&n==s.bytesAsString()&&r==t.className())return i=e}),i},breakNow:function(t){t&&console.log("Break: "+t),this.breakOutOfInterpreter="break"},breakOn:function(t){return this.breakOnMethod=t&&this.findMethod(t)},breakOnReturnFromThisContext:function(){this.breakOnContextChanged=!1,this.breakOnContextReturned=this.activeContext},breakOnSendOrReturn:function(){this.breakOnContextChanged=!0,this.breakOnContextReturned=null},printActiveContext:function(s){function t(t){var e=t.sqInstName?t.sqInstName():t.toString();return(e=JSON.stringify(e).slice(1,-1)).length>s-3&&(e=e.slice(0,s-3)+"..."),e}s=s||72;for(var e=this.activeContext,i="number"==typeof e.pointers[Squeak.BlockContext_argumentCount],r=e.pointers[Squeak.Context_closure],n=!i&&!r.isNil,a=i?e.pointers[Squeak.BlockContext_home]:e,o=n?r.pointers[Squeak.Closure_numArgs]:a.pointers[Squeak.Context_method].methodTempCount(),h=this.decodeSqueakSP(0),c=a.contextSizeWithStack(this)-1,u=h+1,l=u+o-1,p="",m=h;m<=c;m++){var d="";m==h?d="=rcvr":m<=l&&(d="=tmp"+(m-u)),p+="\nctx["+m+"]"+d+": "+t(a.pointers[m])}if(i){p+="\n";var f=e.pointers[3],v=this.decodeSqueakSP(1),k=v+f;for(m=v;m<=this.sp;m++){d="";m<=k&&(d="=arg"+(m-v)),p+="\nblk["+m+"]"+d+": "+t(e.pointers[m])}}return p},printAllProcesses:function(){for(var t=this.specialObjects[Squeak.splOb_SchedulerAssociation].pointers[Squeak.Assn_value],e=t.pointers[Squeak.ProcSched_activeProcess],s="Active: "+this.printProcess(e,!0),i=t.pointers[Squeak.ProcSched_processLists].pointers,r=i.length-1;0<=r;r--)for(var n=i[r].pointers[Squeak.LinkedList_firstLink];!n.isNil;)s+="\nRunnable: "+this.printProcess(n),n=n.pointers[Squeak.Link_nextLink];for(var a=this.specialObjects[Squeak.splOb_ClassSemaphore],o=this.image.someInstanceOf(a);o;){for(n=o.pointers[Squeak.LinkedList_firstLink];!n.isNil;)s+="\nWaiting: "+this.printProcess(n),n=n.pointers[Squeak.Link_nextLink];o=this.image.nextInstanceAfter(o)}return s},printProcess:function(t,e){var s=t.pointers[Squeak.Proc_suspendedContext],i=t.pointers[Squeak.Proc_priority],r=this.printStack(e?null:s);return t.toString()+" at priority "+i+"\n"+r},printByteCodes:function(t,e,s,i){return t=t||this.method,new Squeak.InstructionPrinter(t,this).printInstructions(e,s,i)},willSendOrReturn:function(){var t=this.method.bytes[this.pc];if(120<=t&&t<=125)return!0;if(t<131||200==t)return!1;if(176<=t)return!0;if(t<=134){var e;if(132===t){if(1<this.method.bytes[this.pc+1]>>5)return!1;e=this.method.bytes[this.pc+2]}else e=this.method.bytes[this.pc+1]&(134===t?63:31);if("blockCopy:"!==this.method.methodGetLiteral(e).bytesAsString())return!0}return!1},nextSendSelector:function(){var t,e=this.method.bytes[this.pc];if(e<131||200==e)return null;if(208<=e)t=this.method.methodGetLiteral(15&e);else if(176<=e)t=this.specialSelectors[2*(e-176)];else if(e<=134){var s;if(132===e){if(1<this.method.bytes[this.pc+1]>>5)return null;s=this.method.bytes[this.pc+2]}else s=this.method.bytes[this.pc+1]&(134===e?63:31);t=this.method.methodGetLiteral(s)}if(t){var i=t.bytesAsString();if("blockCopy:"!==i)return i}}}),Object.subclass("Squeak.InterpreterProxy","initialization",{VM_PROXY_MAJOR:1,VM_PROXY_MINOR:11,initialize:function(e){this.vm=e,this.remappableOops=[],Object.defineProperty(this,"successFlag",{get:function(){return e.primHandler.success},set:function(t){e.primHandler.success=t}})},majorVersion:function(){return this.VM_PROXY_MAJOR},minorVersion:function(){return this.VM_PROXY_MINOR}},"success",{failed:function(){return!this.successFlag},primitiveFail:function(){this.successFlag=!1},primitiveFailFor:function(t){this.successFlag=!1},success:function(t){t||(this.successFlag=!1)}},"stack access",{pop:function(t){this.vm.popN(t)},popthenPush:function(t,e){this.vm.popNandPush(t,e)},push:function(t){this.vm.push(t)},pushBool:function(t){this.vm.push(t?this.vm.trueObj:this.vm.falseObj)},pushInteger:function(t){this.vm.push(t)},pushFloat:function(t){this.vm.push(this.floatObjectOf(t))},stackValue:function(t){return this.vm.stackValue(t)},stackIntegerValue:function(t){var e=this.vm.stackValue(t);return"number"==typeof e?e:(this.successFlag=!1,0)},stackFloatValue:function(t){this.vm.success=!0;var e=this.vm.stackIntOrFloat(t);return this.vm.success?e:(this.successFlag=!1,0)},stackObjectValue:function(t){var e=this.vm.stackValue(t);return"number"!=typeof e?e:(this.successFlag=!1,this.vm.nilObj)},stackBytes:function(t){var e=this.vm.stackValue(t);return e.bytes?e.bytes:("number"!=typeof e&&e.isBytes()||(this.successFlag=!1),[])},stackWords:function(t){var e=this.vm.stackValue(t);return e.words?e.words:("number"!=typeof e&&e.isWords()||(this.successFlag=!1),[])},stackInt32Array:function(t){var e=this.vm.stackValue(t);return e.words?e.wordsAsInt32Array():("number"!=typeof e&&e.isWords()||(this.successFlag=!1),[])},stackInt16Array:function(t){var e=this.vm.stackValue(t);return e.words?e.wordsAsInt16Array():("number"!=typeof e&&e.isWords()||(this.successFlag=!1),[])},stackUint16Array:function(t){var e=this.vm.stackValue(t);return e.words?e.wordsAsUint16Array():("number"!=typeof e&&e.isWords()||(this.successFlag=!1),[])}},"object access",{isBytes:function(t){return"number"!=typeof t&&t.isBytes()},isWords:function(t){return"number"!=typeof t&&t.isWords()},isWordsOrBytes:function(t){return"number"!=typeof t&&t.isWordsOrBytes()},isPointers:function(t){return"number"!=typeof t&&t.isPointers()},isIntegerValue:function(t){return"number"==typeof t&&-1073741824<=t&&t<=1073741823},isArray:function(t){return t.sqClass===this.vm.specialObjects[Squeak.splOb_ClassArray]},isMemberOf:function(t,e){var s=t.sqClass.pointers[Squeak.Class_name].bytes;if(e.length!==s.length)return!1;for(var i=0;i<e.length;i++)if(e.charCodeAt(i)!==s[i])return!1;return!0},booleanValueOf:function(t){return!!t.isTrue||!t.isFalse&&(this.successFlag=!1)},positive32BitValueOf:function(t){return this.vm.primHandler.positive32BitValueOf(t)},positive32BitIntegerFor:function(t){return this.vm.primHandler.pos32BitIntFor(t)},floatValueOf:function(t){return t.isFloat?t.float:(this.successFlag=!1,0)},floatObjectOf:function(t){return this.vm.primHandler.makeFloat(t)},fetchPointerofObject:function(t,e){return e.pointers[t]},fetchBytesofObject:function(t,e){var s=e.pointers[t];return s.bytes?s.bytes:s.words?s.wordsAsUint8Array():("number"!=typeof s&&s.isWordsOrBytes()||(this.successFlag=!1),[])},fetchWordsofObject:function(t,e){var s=e.pointers[t];return s.words?s.words:("number"!=typeof s&&s.isWords()||(this.successFlag=!1),[])},fetchInt32ArrayofObject:function(t,e){var s=e.pointers[t];return s.words?s.wordsAsInt32Array():("number"!=typeof s&&s.isWords()||(this.successFlag=!1),[])},fetchInt16ArrayofObject:function(t,e){var s=e.pointers[t];return s.words?s.wordsAsInt16Array():("number"!=typeof s&&s.isWords()||(this.successFlag=!1),[])},fetchUint16ArrayofObject:function(t,e){var s=e.pointers[t];return s.words?s.wordsAsUint16Array():("number"!=typeof s&&s.isWords()||(this.successFlag=!1),[])},fetchIntegerofObject:function(t,e){var s=e.pointers[t];return"number"==typeof s?s:(this.successFlag=!1,0)},fetchLong32ofObject:function(t,e){return e.words[t]},fetchFloatofObject:function(t,e){return this.floatValueOf(e.pointers[t])},storeIntegerofObjectwithValue:function(t,e,s){"number"==typeof s?e.pointers[t]=s:this.successFlag=!1},storePointerofObjectwithValue:function(t,e,s){e.pointers[t]=s},stObjectatput:function(t,e,s){if(t.sqClass!==this.classArray())throw Error("Array expected");if(e<1||e>=t.pointers.length)return this.successFlag=!1;t.pointers[e]=s}},"constant access",{isKindOfInteger:function(t){return"number"==typeof t||t.sqClass==this.classLargeNegativeInteger()||t.sqClass==this.classLargePositiveInteger()},classArray:function(){return this.vm.specialObjects[Squeak.splOb_ClassArray]},classBitmap:function(){return this.vm.specialObjects[Squeak.splOb_ClassBitmap]},classSmallInteger:function(){return this.vm.specialObjects[Squeak.splOb_ClassInteger]},classLargePositiveInteger:function(){return this.vm.specialObjects[Squeak.splOb_ClassLargePositiveInteger]},classLargeNegativeInteger:function(){return this.vm.specialObjects[Squeak.splOb_ClassLargeNegativeInteger]},classPoint:function(){return this.vm.specialObjects[Squeak.splOb_ClassPoint]},classString:function(){return this.vm.specialObjects[Squeak.splOb_ClassString]},nilObject:function(){return this.vm.nilObj},falseObject:function(){return this.vm.falseObj},trueObject:function(){return this.vm.trueObj}},"vm functions",{instantiateClassindexableSize:function(t,e){return this.vm.instantiateClass(t,e)},methodArgumentCount:function(){return this.argCount},makePointwithxValueyValue:function(t,e){return this.vm.primHandler.makePointWithXandY(t,e)},pushRemappableOop:function(t){this.remappableOops.push(t)},popRemappableOop:function(){return this.remappableOops.pop()},showDisplayBitsLeftTopRightBottom:function(t,e,s,i,r){if(e<i&&s<r){var n={left:e,top:s,right:i,bottom:r};this.vm.primHandler.displayDirty(t,n)}},ioLoadFunctionFrom:function(t,e){return this.vm.primHandler.loadFunctionFrom(t,e)}}),Object.subclass("Squeak.InstructionStream","initialization",{initialize:function(t,e){this.vm=e,this.method=t,this.pc=0,this.specialConstants=[e.trueObj,e.falseObj,e.nilObj,-1,0,1,2]}},"decoding",{interpretNextInstructionFor:function(t){var e=this.method,s=e.bytes[this.pc++],i=s/16|0,r=s%16;if(0==i)return t.pushReceiverVariable(r);if(1==i)return t.pushTemporaryVariable(r);if(2==i)return t.pushConstant(e.methodGetLiteral(r));if(3==i)return t.pushConstant(e.methodGetLiteral(16+r));if(4==i)return t.pushLiteralVariable(e.methodGetLiteral(r));if(5==i)return t.pushLiteralVariable(e.methodGetLiteral(16+r));if(6==i)return r<8?t.popIntoReceiverVariable(r):t.popIntoTemporaryVariable(r-8);if(7==i){if(0==r)return t.pushReceiver();if(r<8)return t.pushConstant(this.specialConstants[r-1]);if(8==r)return t.methodReturnReceiver();if(r<12)return t.methodReturnConstant(this.specialConstants[r-9]);if(12==r)return t.methodReturnTop();if(13==r)return t.blockReturnTop();if(13<r)throw Error("unusedBytecode")}return 8==i?this.interpretExtension(r,e,t):9==i?r<8?t.jump(1+r):t.jumpIf(!1,r-8+1):10==i?(s=this.method.bytes[this.pc++],r<8?t.jump(256*(r-4)+s):t.jumpIf(r<12,256*(3&r)+s)):11==i?t.send(this.vm.specialSelectors[2*r],this.vm.specialSelectors[2*r+1],!1):12==i?t.send(this.vm.specialSelectors[2*(16+r)],this.vm.specialSelectors[2*(16+r)+1],!1):12<i?t.send(e.methodGetLiteral(r),i-13,!1):void 0},interpretExtension:function(t,e,s){if(t<=6){var i=this.method.bytes[this.pc++];if(t<=2){var r=i/64|0,n=i%64;if(0===t){if(0===r)return s.pushReceiverVariable(n);if(1===r)return s.pushTemporaryVariable(n);if(2===r)return s.pushConstant(this.method.methodGetLiteral(n));if(3===r)return s.pushLiteralVariable(this.method.methodGetLiteral(n))}if(1===t){if(0===r)return s.storeIntoReceiverVariable(n);if(1===r)return s.storeIntoTemporaryVariable(n);if(2===r)throw Error("illegalStore");if(3===r)return s.storeIntoLiteralVariable(this.method.methodGetLiteral(n))}if(2===t){if(0===r)return s.popIntoReceiverVariable(n);if(1===r)return s.popIntoTemporaryVariable(n);if(2===r)throw Error("illegalStore");if(3===r)return s.popIntoLiteralVariable(this.method.methodGetLiteral(n))}}if(3===t)return s.send(this.method.methodGetLiteral(i%32),i/32|0,!1);if(4===t){var a=this.method.bytes[this.pc++];if(0===(r=i/32|0))return s.send(this.method.methodGetLiteral(a),i%32,!1);if(1===r)return s.send(this.method.methodGetLiteral(a),i%32,!0);if(2===r)return s.pushReceiverVariable(a);if(3===r)return s.pushConstant(this.method.methodGetLiteral(a));if(4===r)return s.pushLiteralVariable(this.method.methodGetLiteral(a));if(5===r)return s.storeIntoReceiverVariable(a);if(6===r)return s.popIntoReceiverVariable(a);if(7===r)return s.storeIntoLiteralVariable(this.method.methodGetLiteral(a))}if(5===t)return s.send(this.method.methodGetLiteral(31&i),i>>5,!0);if(6===t)return s.send(this.method.methodGetLiteral(63&i),i>>6,!1)}if(7===t)return s.doPop();if(8===t)return s.doDup();if(9===t)return s.pushActiveContext();i=this.method.bytes[this.pc++];if(10===t)return i<128?s.pushNewArray(i):s.popIntoNewArray(i-128);a=this.method.bytes[this.pc++];if(11===t)return s.callPrimitive(i+256*a);if(12===t)return s.pushRemoteTemp(i,a);if(13===t)return s.storeIntoRemoteTemp(i,a);if(14===t)return s.popIntoRemoteTemp(i,a);var o=this.method.bytes[this.pc++];return s.pushClosureCopy(i>>4,15&i,256*a+o)}}),Object.subclass("Squeak.InstructionPrinter","initialization",{initialize:function(t,e){this.method=t,this.vm=e}},"printing",{printInstructions:function(t,e,s){for(this.indent=t,this.highlight=e,this.highlightPC=s,this.innerIndents={},this.result="",this.scanner=new Squeak.InstructionStream(this.method,this.vm),this.oldPC=this.scanner.pc,this.endPC=0,this.done=!1;!this.done;)this.scanner.interpretNextInstructionFor(this);return this.result},print:function(t){this.oldPC===this.highlightPC?this.highlight&&(this.result+=this.highlight):this.indent&&(this.result+=this.indent),this.result+=this.oldPC;for(var e=0;e<this.innerIndents[this.oldPC];e++)this.result+="   ";this.result+=" <";for(e=this.oldPC;e<this.scanner.pc;e++)e>this.oldPC&&(this.result+=" "),this.result+=(this.method.bytes[e]+256).toString(16).substr(-2).toUpperCase();this.result+="> "+t+"\n",this.oldPC=this.scanner.pc}},"decoding",{blockReturnTop:function(){this.print("blockReturn")},doDup:function(){this.print("dup")},doPop:function(){this.print("pop")},jump:function(t){this.print("jumpTo: "+(this.scanner.pc+t)),this.scanner.pc+t>this.endPC&&(this.endPC=this.scanner.pc+t)},jumpIf:function(t,e){this.print((t?"jumpIfTrue: ":"jumpIfFalse: ")+(this.scanner.pc+e)),this.scanner.pc+e>this.endPC&&(this.endPC=this.scanner.pc+e)},methodReturnReceiver:function(){this.print("return: receiver"),this.done=this.scanner.pc>this.endPC},methodReturnTop:function(){this.print("return: topOfStack"),this.done=this.scanner.pc>this.endPC},methodReturnConstant:function(t){this.print("returnConst: "+t.toString()),this.done=this.scanner.pc>this.endPC},popIntoLiteralVariable:function(t){this.print("popIntoBinding: "+t.assnKeyAsString())},popIntoReceiverVariable:function(t){this.print("popIntoInstVar: "+t)},popIntoTemporaryVariable:function(t){this.print("popIntoTemp: "+t)},pushActiveContext:function(){this.print("push: thisContext")},pushConstant:function(t){var e=t.sqInstName?t.sqInstName():t.toString();this.print("pushConst: "+e)},pushLiteralVariable:function(t){this.print("pushBinding: "+t.assnKeyAsString())},pushReceiver:function(){this.print("push: self")},pushReceiverVariable:function(t){this.print("pushInstVar: "+t)},pushTemporaryVariable:function(t){this.print("pushTemp: "+t)},send:function(t,e,s){this.print((s?"superSend: #":"send: #")+(t.bytesAsString?t.bytesAsString():t))},storeIntoLiteralVariable:function(t){this.print("storeIntoBinding: "+t.assnKeyAsString())},storeIntoReceiverVariable:function(t){this.print("storeIntoInstVar: "+t)},storeIntoTemporaryVariable:function(t){this.print("storeIntoTemp: "+t)},pushNewArray:function(t){this.print("push: (Array new: "+t+")")},popIntoNewArray:function(t){this.print("pop: "+t+" into: (Array new: "+t+")")},pushRemoteTemp:function(t,e){this.print("push: "+t+" ofTemp: "+e)},storeIntoRemoteTemp:function(t,e){this.print("storeInto: "+t+" ofTemp: "+e)},popIntoRemoteTemp:function(t,e){this.print("popInto: "+t+" ofTemp: "+e)},pushClosureCopy:function(t,e,s){var i=this.scanner.pc,r=i+s;this.print("closure("+i+"-"+(r-1)+"): "+t+" copied, "+e+" args");for(var n=i;n<r;n++)this.innerIndents[n]=(this.innerIndents[n]||0)+1;r>this.endPC&&(this.endPC=r)},callPrimitive:function(t){this.print("primitive: "+t)}}),Object.subclass("Squeak.Primitives","initialization",{initialize:function(t,e){this.vm=t,this.oldPrims=!this.vm.image.hasClosures,this.allowAccessBeyondSP=this.oldPrims,this.deferDisplayUpdates=!1,this.semaphoresToSignal=[],this.initDisplay(e),this.initAtCache(),this.initModules(),this.initPlugins(),t.image.isSpur&&(this.charFromInt=this.charFromIntSpur,this.charToInt=this.charToIntSpur,this.identityHash=this.identityHashSpur)},initDisplay:function(t){this.display=t},initModules:function(){this.loadedModules={},this.builtinModules={},this.patchModules={},this.interpreterProxy=new Squeak.InterpreterProxy(this.vm)},initPlugins:function(){}},"dispatch",{quickSendOther:function(t,e){switch(this.success=!0,e){case 0:return this.popNandPushIfOK(2,this.objectAt(!0,!0,!1));case 1:return this.popNandPushIfOK(3,this.objectAtPut(!0,!0,!1));case 2:return this.popNandPushIfOK(1,this.objectSize(!0));case 6:return this.pop2andPushBoolIfOK(this.vm.stackValue(1)===this.vm.stackValue(0));case 7:return this.popNandPushIfOK(1,this.vm.getClass(this.vm.top()));case 8:return this.popNandPushIfOK(2,this.doBlockCopy());case 9:return this.primitiveBlockValue(0);case 10:return this.primitiveBlockValue(1)}return!1},doPrimitive:function(t,e,s){if(this.success=!0,t<128)switch(t){case 1:return this.popNandPushIntIfOK(2,this.stackInteger(1)+this.stackInteger(0));case 2:return this.popNandPushIntIfOK(2,this.stackInteger(1)-this.stackInteger(0));case 3:return this.pop2andPushBoolIfOK(this.stackInteger(1)<this.stackInteger(0));case 4:return this.pop2andPushBoolIfOK(this.stackInteger(1)>this.stackInteger(0));case 5:return this.pop2andPushBoolIfOK(this.stackInteger(1)<=this.stackInteger(0));case 6:return this.pop2andPushBoolIfOK(this.stackInteger(1)>=this.stackInteger(0));case 7:return this.pop2andPushBoolIfOK(this.stackInteger(1)===this.stackInteger(0));case 8:return this.pop2andPushBoolIfOK(this.stackInteger(1)!==this.stackInteger(0));case 9:return this.popNandPushIntIfOK(2,this.stackInteger(1)*this.stackInteger(0));case 10:return this.popNandPushIntIfOK(2,this.vm.quickDivide(this.stackInteger(1),this.stackInteger(0)));case 11:return this.popNandPushIntIfOK(2,this.vm.mod(this.stackInteger(1),this.stackInteger(0)));case 12:return this.popNandPushIntIfOK(2,this.vm.div(this.stackInteger(1),this.stackInteger(0)));case 13:return this.popNandPushIntIfOK(2,this.stackInteger(1)/this.stackInteger(0)|0);case 14:return this.popNandPushIfOK(2,this.doBitAnd());case 15:return this.popNandPushIfOK(2,this.doBitOr());case 16:return this.popNandPushIfOK(2,this.doBitXor());case 17:return this.popNandPushIfOK(2,this.doBitShift());case 18:return this.primitiveMakePoint(e,!1);case 19:case 20:case 21:case 22:return!1;case 23:return this.primitiveLessThanLargeIntegers();case 24:return this.primitiveGreaterThanLargeIntegers();case 25:return this.primitiveLessOrEqualLargeIntegers();case 26:return this.primitiveGreaterOrEqualLargeIntegers();case 27:return this.primitiveEqualLargeIntegers();case 28:return this.primitiveNotEqualLargeIntegers();case 29:case 30:case 31:case 32:case 33:case 34:case 35:case 36:case 37:return!1;case 38:return this.popNandPushIfOK(e+1,this.objectAt(!1,!1,!1));case 39:return this.popNandPushIfOK(e+1,this.objectAtPut(!1,!1,!1));case 40:return this.popNandPushFloatIfOK(e+1,this.stackInteger(0));case 41:return this.popNandPushFloatIfOK(e+1,this.stackFloat(1)+this.stackFloat(0));case 42:return this.popNandPushFloatIfOK(e+1,this.stackFloat(1)-this.stackFloat(0));case 43:return this.pop2andPushBoolIfOK(this.stackFloat(1)<this.stackFloat(0));case 44:return this.pop2andPushBoolIfOK(this.stackFloat(1)>this.stackFloat(0));case 45:return this.pop2andPushBoolIfOK(this.stackFloat(1)<=this.stackFloat(0));case 46:return this.pop2andPushBoolIfOK(this.stackFloat(1)>=this.stackFloat(0));case 47:return this.pop2andPushBoolIfOK(this.stackFloat(1)===this.stackFloat(0));case 48:return this.pop2andPushBoolIfOK(this.stackFloat(1)!==this.stackFloat(0));case 49:return this.popNandPushFloatIfOK(e+1,this.stackFloat(1)*this.stackFloat(0));case 50:return this.popNandPushFloatIfOK(e+1,this.safeFDiv(this.stackFloat(1),this.stackFloat(0)));case 51:return this.popNandPushIfOK(e+1,this.floatAsSmallInt(this.stackFloat(0)));case 52:return!1;case 53:return this.popNandPushIntIfOK(e+1,this.frexp_exponent(this.stackFloat(0))-1);case 54:return this.popNandPushFloatIfOK(2,this.ldexp(this.stackFloat(1),this.stackFloat(0)));case 55:return this.popNandPushFloatIfOK(e+1,Math.sqrt(this.stackFloat(0)));case 56:return this.popNandPushFloatIfOK(e+1,Math.sin(this.stackFloat(0)));case 57:return this.popNandPushFloatIfOK(e+1,Math.atan(this.stackFloat(0)));case 58:return this.popNandPushFloatIfOK(e+1,Math.log(this.stackFloat(0)));case 59:return this.popNandPushFloatIfOK(e+1,Math.exp(this.stackFloat(0)));case 60:return this.popNandPushIfOK(e+1,this.objectAt(!1,!1,!1));case 61:return this.popNandPushIfOK(e+1,this.objectAtPut(!1,!1,!1));case 62:return this.popNandPushIfOK(e+1,this.objectSize(!1));case 63:return this.popNandPushIfOK(e+1,this.objectAt(!1,!0,!1));case 64:return this.popNandPushIfOK(e+1,this.objectAtPut(!1,!0,!1));case 65:case 66:case 67:return!1;case 68:return this.popNandPushIfOK(e+1,this.objectAt(!1,!1,!0));case 69:return this.popNandPushIfOK(e+1,this.objectAtPut(!1,!1,!0));case 70:return this.popNandPushIfOK(e+1,this.instantiateClass(this.stackNonInteger(0),0));case 71:return this.popNandPushIfOK(e+1,this.instantiateClass(this.stackNonInteger(1),this.stackPos32BitInt(0)));case 72:return this.primitiveArrayBecome(e,!1);case 73:return this.popNandPushIfOK(e+1,this.objectAt(!1,!1,!0));case 74:return this.popNandPushIfOK(e+1,this.objectAtPut(!1,!1,!0));case 75:return this.popNandPushIfOK(e+1,this.identityHash(this.stackNonInteger(0)));case 76:return this.primitiveStoreStackp(e);case 77:return this.popNandPushIfOK(e+1,this.someInstanceOf(this.stackNonInteger(0)));case 78:return this.popNandPushIfOK(e+1,this.nextInstanceAfter(this.stackNonInteger(0)));case 79:return this.primitiveNewMethod(e);case 80:return this.popNandPushIfOK(2,this.doBlockCopy());case 81:return this.primitiveBlockValue(e);case 82:return this.primitiveBlockValueWithArgs(e);case 83:return this.vm.primitivePerform(e);case 84:return this.vm.primitivePerformWithArgs(e,!1);case 85:return this.primitiveSignal();case 86:return this.primitiveWait();case 87:return this.primitiveResume();case 88:return this.primitiveSuspend();case 89:return this.vm.flushMethodCache();case 90:return this.primitiveMousePoint(e);case 91:return this.primitiveTestDisplayDepth(e);case 93:return this.primitiveInputSemaphore(e);case 94:return this.primitiveGetNextEvent(e);case 95:return this.primitiveInputWord(e);case 96:return this.namedPrimitive("BitBltPlugin","primitiveCopyBits",e);case 97:return this.primitiveSnapshot(e);case 99:return this.primitiveLoadImageSegment(e);case 100:return this.vm.primitivePerformWithArgs(e,!0);case 101:return this.primitiveBeCursor(e);case 102:return this.primitiveBeDisplay(e);case 103:case 104:return!1;case 105:return this.popNandPushIfOK(e+1,this.doStringReplace());case 106:return this.primitiveScreenSize(e);case 107:return this.primitiveMouseButtons(e);case 108:return this.primitiveKeyboardNext(e);case 109:return this.primitiveKeyboardPeek(e);case 110:return this.pop2andPushBoolIfOK(this.vm.stackValue(1)===this.vm.stackValue(0));case 111:return this.popNandPushIfOK(e+1,this.vm.getClass(this.vm.top()));case 112:return this.popNandPushIfOK(e+1,this.vm.image.bytesLeft());case 113:return this.primitiveQuit(e);case 114:return this.primitiveExitToDebugger(e);case 115:return this.primitiveChangeClass(e);case 116:return this.vm.flushMethodCacheForMethod(this.vm.top());case 117:return this.doNamedPrimitive(e,s);case 118:return this.primitiveDoPrimitiveWithArgs(e);case 119:return this.vm.flushMethodCacheForSelector(this.vm.top());case 120:return!1;case 121:return this.primitiveImageName(e);case 122:return this.primitiveReverseDisplay(e);case 124:return this.popNandPushIfOK(2,this.registerSemaphore(Squeak.splOb_TheLowSpaceSemaphore));case 125:return this.popNandPushIfOK(2,this.setLowSpaceThreshold());case 126:return this.primitiveDeferDisplayUpdates(e);case 127:return this.primitiveShowDisplayRect(e)}else if(t<256)switch(t){case 128:return this.primitiveArrayBecome(e,!0);case 129:return this.popNandPushIfOK(1,this.vm.image.specialObjectsArray);case 130:return this.primitiveFullGC(e);case 131:return this.primitivePartialGC(e);case 132:return this.pop2andPushBoolIfOK(this.pointsTo(this.stackNonInteger(1),this.vm.top()));case 133:return!0;case 134:return this.popNandPushIfOK(2,this.registerSemaphore(Squeak.splOb_TheInterruptSemaphore));case 135:return this.popNandPushIfOK(1,this.millisecondClockValue());case 136:return this.primitiveSignalAtMilliseconds(e);case 137:return this.popNandPushIfOK(1,this.secondClock());case 138:return this.popNandPushIfOK(e+1,this.someObject());case 139:return this.popNandPushIfOK(e+1,this.nextObject(this.vm.top()));case 140:return this.primitiveBeep(e);case 141:return this.primitiveClipboardText(e);case 142:return this.popNandPushIfOK(e+1,this.makeStString(this.filenameToSqueak(Squeak.vmPath)));case 143:case 144:return this.primitiveShortAtAndPut(e);case 145:return this.primitiveConstantFill(e);case 146:return this.namedPrimitive("JoystickTabletPlugin","primitiveReadJoystick",e);case 147:return this.namedPrimitive("BitBltPlugin","primitiveWarpBits",e);case 148:return this.popNandPushIfOK(e+1,this.vm.image.clone(this.vm.top()));case 149:return this.primitiveGetAttribute(e);case 150:if(this.oldPrims)return this.primitiveFileAtEnd(e);case 151:if(this.oldPrims)return this.primitiveFileClose(e);case 152:if(this.oldPrims)return this.primitiveFileGetPosition(e);case 153:if(this.oldPrims)return this.primitiveFileOpen(e);case 154:if(this.oldPrims)return this.primitiveFileRead(e);case 155:if(this.oldPrims)return this.primitiveFileSetPosition(e);case 156:if(this.oldPrims)return this.primitiveFileDelete(e);case 157:if(this.oldPrims)return this.primitiveFileSize(e);case 158:if(this.oldPrims)return this.primitiveFileWrite(e);case 159:if(this.oldPrims)return this.primitiveFileRename(e);break;case 160:return this.oldPrims?this.primitiveDirectoryCreate(e):this.primitiveAdoptInstance(e);case 161:if(this.oldPrims)return this.primitiveDirectoryDelimitor(e);break;case 162:if(this.oldPrims)return this.primitiveDirectoryLookup(e);break;case 163:if(this.oldPrims)return this.primitiveDirectoryDelete(e);break;case 165:case 166:return this.primitiveIntegerAtAndPut(e);case 167:return!1;case 168:return this.primitiveCopyObject(e);case 169:return this.oldPrims?this.primitiveDirectorySetMacTypeAndCreator(e):this.pop2andPushBoolIfOK(this.vm.stackValue(1)!==this.vm.stackValue(0));case 170:return this.oldPrims?this.namedPrimitive("SoundPlugin","primitiveSoundStart",e):this.primitiveAsCharacter(e);case 171:return this.oldPrims?this.namedPrimitive("SoundPlugin","primitiveSoundStartWithSemaphore",e):this.popNandPushIfOK(e+1,this.stackNonInteger(0).hash);case 172:if(this.oldPrims)return this.namedPrimitive("SoundPlugin","primitiveSoundStop",e);break;case 173:return this.oldPrims?this.namedPrimitive("SoundPlugin","primitiveSoundAvailableSpace",e):this.popNandPushIfOK(e+1,this.objectAt(!1,!1,!0));case 174:return this.oldPrims?this.namedPrimitive("SoundPlugin","primitiveSoundPlaySamples",e):this.popNandPushIfOK(e+1,this.objectAtPut(!1,!1,!0));case 175:return this.oldPrims?this.namedPrimitive("SoundPlugin","primitiveSoundPlaySilence",e):this.popNandPushIfOK(e+1,this.behaviorHash(this.stackNonInteger(0)));case 176:if(this.oldPrims)return this.namedPrimitive("SoundGenerationPlugin","primWaveTableSoundmixSampleCountintostartingAtpan",e);break;case 177:return this.oldPrims?this.namedPrimitive("SoundGenerationPlugin","primFMSoundmixSampleCountintostartingAtpan",e):this.popNandPushIfOK(e+1,this.allInstancesOf(this.stackNonInteger(0)));case 178:return this.oldPrims?this.namedPrimitive("SoundGenerationPlugin","primPluckedSoundmixSampleCountintostartingAtpan",e):!1;case 179:if(this.oldPrims)return this.namedPrimitive("SoundGenerationPlugin","primSampledSoundmixSampleCountintostartingAtpan",e);break;case 180:return this.oldPrims?this.namedPrimitive("SoundGenerationPlugin","primitiveMixFMSound",e):!1;case 181:return this.oldPrims?this.namedPrimitive("SoundGenerationPlugin","primitiveMixPluckedSound",e):this.primitiveSizeInBytesOfInstance(e);case 182:return this.oldPrims?this.namedPrimitive("SoundGenerationPlugin","oldprimSampledSoundmixSampleCountintostartingAtleftVolrightVol",e):this.primitiveSizeInBytes(e);case 183:if(this.oldPrims)return this.namedPrimitive("SoundGenerationPlugin","primitiveApplyReverb",e);break;case 184:if(this.oldPrims)return this.namedPrimitive("SoundGenerationPlugin","primitiveMixLoopedSampledSound",e);break;case 185:return this.oldPrims?this.namedPrimitive("SoundGenerationPlugin","primitiveMixSampledSound",e):this.primitiveExitCriticalSection(e);case 186:if(this.oldPrims)break;return this.primitiveEnterCriticalSection(e);case 187:if(this.oldPrims)break;return this.primitiveTestAndSetOwnershipOfCriticalSection(e);case 188:if(this.oldPrims)break;return this.primitiveExecuteMethodArgsArray(e);case 189:return this.oldPrims?this.namedPrimitive("SoundPlugin","primitiveSoundInsertSamples",e):this.primitiveExecuteMethod(e);case 190:if(this.oldPrims)return this.namedPrimitive("SoundPlugin","primitiveSoundStartRecording",e);case 191:if(this.oldPrims)return this.namedPrimitive("SoundPlugin","primitiveSoundStopRecording",e);case 192:if(this.oldPrims)return this.namedPrimitive("SoundPlugin","primitiveSoundGetRecordingSampleRate",e);case 193:if(this.oldPrims)return this.namedPrimitive("SoundPlugin","primitiveSoundRecordSamples",e);case 194:if(this.oldPrims)return this.namedPrimitive("SoundPlugin","primitiveSoundSetRecordLevel",e);break;case 195:case 196:case 197:case 198:case 199:return!1;case 200:return this.oldPrims?this.namedPrimitive("SocketPlugin","primitiveInitializeNetwork",e):this.primitiveClosureCopyWithCopiedValues(e);case 201:return this.oldPrims?this.namedPrimitive("SocketPlugin","primitiveResolverStartNameLookup",e):this.primitiveClosureValue(e);case 202:return this.oldPrims?this.namedPrimitive("SocketPlugin","primitiveResolverNameLookupResult",e):this.primitiveClosureValue(e);case 203:return this.oldPrims?this.namedPrimitive("SocketPlugin","primitiveResolverStartAddressLookup",e):this.primitiveClosureValue(e);case 204:return this.oldPrims?this.namedPrimitive("SocketPlugin","primitiveResolverAddressLookupResult",e):this.primitiveClosureValue(e);case 205:return this.oldPrims?this.namedPrimitive("SocketPlugin","primitiveResolverAbortLookup",e):this.primitiveClosureValue(e);case 206:return this.oldPrims?this.namedPrimitive("SocketPlugin","primitiveResolverLocalAddress",e):this.primitiveClosureValueWithArgs(e);case 207:if(this.oldPrims)return this.namedPrimitive("SocketPlugin","primitiveResolverStatus",e);case 208:if(this.oldPrims)return this.namedPrimitive("SocketPlugin","primitiveResolverError",e);case 209:if(this.oldPrims)return this.namedPrimitive("SocketPlugin","primitiveSocketCreate",e);break;case 210:return this.oldPrims?this.namedPrimitive("SocketPlugin","primitiveSocketDestroy",e):this.popNandPushIfOK(2,this.objectAt(!1,!1,!1));case 211:return this.oldPrims?this.namedPrimitive("SocketPlugin","primitiveSocketConnectionStatus",e):this.popNandPushIfOK(3,this.objectAtPut(!1,!1,!1));case 212:return this.oldPrims?this.namedPrimitive("SocketPlugin","primitiveSocketError",e):this.popNandPushIfOK(1,this.objectSize(!1));case 213:if(this.oldPrims)return this.namedPrimitive("SocketPlugin","primitiveSocketLocalAddress",e);case 214:if(this.oldPrims)return this.namedPrimitive("SocketPlugin","primitiveSocketLocalPort",e);case 215:if(this.oldPrims)return this.namedPrimitive("SocketPlugin","primitiveSocketRemoteAddress",e);case 216:if(this.oldPrims)return this.namedPrimitive("SocketPlugin","primitiveSocketRemotePort",e);case 217:if(this.oldPrims)return this.namedPrimitive("SocketPlugin","primitiveSocketConnectToPort",e);case 218:if(this.oldPrims)return this.namedPrimitive("SocketPlugin","primitiveSocketListenOnPort",e);case 219:if(this.oldPrims)return this.namedPrimitive("SocketPlugin","primitiveSocketCloseConnection",e);case 220:if(this.oldPrims)return this.namedPrimitive("SocketPlugin","primitiveSocketAbortConnection",e);break;case 221:return this.oldPrims?this.namedPrimitive("SocketPlugin","primitiveSocketReceiveDataBufCount",e):this.primitiveClosureValueNoContextSwitch(e);case 222:return this.oldPrims?this.namedPrimitive("SocketPlugin","primitiveSocketReceiveDataAvailable",e):this.primitiveClosureValueNoContextSwitch(e);case 223:if(this.oldPrims)return this.namedPrimitive("SocketPlugin","primitiveSocketSendDataBufCount",e);case 224:if(this.oldPrims)return this.namedPrimitive("SocketPlugin","primitiveSocketSendDone",e);break;case 230:return this.primitiveRelinquishProcessorForMicroseconds(e);case 231:return this.primitiveForceDisplayUpdate(e);case 233:return this.primitiveSetFullScreen(e);case 234:if(this.oldPrims)return this.namedPrimitive("MiscPrimitivePlugin","primitiveDecompressFromByteArray",e);case 235:if(this.oldPrims)return this.namedPrimitive("MiscPrimitivePlugin","primitiveCompareString",e);case 236:if(this.oldPrims)return this.namedPrimitive("MiscPrimitivePlugin","primitiveConvert8BitSigned",e);case 237:if(this.oldPrims)return this.namedPrimitive("MiscPrimitivePlugin","primitiveCompressToByteArray",e);case 238:if(this.oldPrims)return this.namedPrimitive("SerialPlugin","primitiveSerialPortOpen",e);case 239:if(this.oldPrims)return this.namedPrimitive("SerialPlugin","primitiveSerialPortClose",e);break;case 240:return this.oldPrims?this.namedPrimitive("SerialPlugin","primitiveSerialPortWrite",e):this.popNandPushIfOK(1,this.microsecondClockUTC());case 241:return this.oldPrims?this.namedPrimitive("SerialPlugin","primitiveSerialPortRead",e):this.popNandPushIfOK(1,this.microsecondClockLocal());case 242:if(this.oldPrims)break;return this.primitiveSignalAtUTCMicroseconds(e);case 243:if(this.oldPrims)return this.namedPrimitive("MiscPrimitivePlugin","primitiveTranslateStringWithTable",e);case 244:if(this.oldPrims)return this.namedPrimitive("MiscPrimitivePlugin","primitiveFindFirstInString",e);case 245:if(this.oldPrims)return this.namedPrimitive("MiscPrimitivePlugin","primitiveIndexOfAsciiInString",e);case 246:if(this.oldPrims)return this.namedPrimitive("MiscPrimitivePlugin","primitiveFindSubstring",e);break;case 248:return this.vm.primitiveInvokeObjectAsMethod(e,s);case 249:return this.primitiveArrayBecome(e,!1);case 254:return this.primitiveVMParameter(e)}else switch(t){case 521:return this.namedPrimitive("MIDIPlugin","primitiveMIDIClosePort",e);case 522:return this.namedPrimitive("MIDIPlugin","primitiveMIDIGetClock",e);case 523:return this.namedPrimitive("MIDIPlugin","primitiveMIDIGetPortCount",e);case 524:return this.namedPrimitive("MIDIPlugin","primitiveMIDIGetPortDirectionality",e);case 525:return this.namedPrimitive("MIDIPlugin","primitiveMIDIGetPortName",e);case 526:return this.namedPrimitive("MIDIPlugin","primitiveMIDIOpenPort",e);case 527:return this.namedPrimitive("MIDIPlugin","primitiveMIDIParameterGetOrSet",e);case 528:return this.namedPrimitive("MIDIPlugin","primitiveMIDIRead",e);case 529:return this.namedPrimitive("MIDIPlugin","primitiveMIDIWrite",e);case 550:return this.namedPrimitive("ADPCMCodecPlugin","primitiveDecodeMono",e);case 551:return this.namedPrimitive("ADPCMCodecPlugin","primitiveDecodeStereo",e);case 552:return this.namedPrimitive("ADPCMCodecPlugin","primitiveEncodeMono",e);case 553:return this.namedPrimitive("ADPCMCodecPlugin","primitiveEncodeStereo",e);case 571:return this.primitiveUnloadModule(e);case 572:return this.primitiveListBuiltinModule(e);case 573:return this.primitiveListLoadedModule(e)}return console.error("primitive "+t+" not implemented yet"),!1},namedPrimitive:function(t,e,s){var i=""===t?this:this.loadedModules[t];void 0===i&&(i=this.loadModule(t),this.loadedModules[t]=i);var r=!1;if(i){this.interpreterProxy.argCount=s;var n=i[e];"function"==typeof n?r=i[e](s):"string"==typeof n?r=this[n](s):this.vm.warnOnce("missing primitive: "+t+"."+e)}else this.vm.warnOnce("missing module: "+t+" ("+e+")");return!0===r||!1===r?r:this.success},doNamedPrimitive:function(t,e){if(e.pointersSize()<2)return!1;var s=e.pointers[1];if(4!==s.pointersSize())return!1;this.primMethod=e;var i=s.pointers[0].bytesAsString(),r=s.pointers[1].bytesAsString();return this.namedPrimitive(i,r,t)},fakePrimitive:function(t,e,s){return this.vm.warnOnce("faking primitive: "+t),void 0===e?this.vm.popN(s):this.vm.popNandPush(s+1,this.makeStObject(e)),!0}},"modules",{loadModule:function(t){var e=Squeak.externalModules[t]||this.builtinModules[t]||this.loadModuleDynamically(t);if(!e)return null;if(this.patchModules[t]&&this.patchModule(e,t),e.setInterpreter&&!e.setInterpreter(this.interpreterProxy))return console.log("Wrong interpreter proxy version: "+t),null;var s=e.initialiseModule;return"function"==typeof s?e.initialiseModule():"string"==typeof s&&this[s](),this.interpreterProxy.failed()?(console.log("Module initialization failed: "+t),null):(console.log("Loaded module: "+t),e)},loadModuleDynamically:function(t){},patchModule:function(t,e){var s=this.patchModules[e];for(var i in s)t[i]=s[i]},unloadModule:function(t){var e=this.loadedModules[t];if(!t||!e||e===this)return null;delete this.loadedModules[t];var s=e.unloadModule;return"function"==typeof s?e.unloadModule(this):"string"==typeof s&&this[s](this),console.log("Unloaded module: "+t),e},loadFunctionFrom:function(t,e){var s=""===e?this:this.loadedModules[e];if(void 0===s&&(s=this.loadModule(e),this.loadedModules[e]=s),!s)return null;var i=s[t];return"function"==typeof i?i.bind(s):"string"==typeof i?this[i].bind(this):(this.vm.warnOnce("missing primitive: "+e+"."+t),null)},primitiveUnloadModule:function(t){var e=this.stackNonInteger(0).bytesAsString();return!!e&&(this.unloadModule(e),this.popNIfOK(t))},primitiveListBuiltinModule:function(t){var e=this.stackInteger(0)-1;if(!this.success)return!1;var s=Object.keys(this.builtinModules);return this.popNandPushIfOK(t+1,this.makeStObject(s[e]))},primitiveListLoadedModule:function(t){var e=this.stackInteger(0)-1;if(!this.success)return!1;var s=[];for(var i in this.loadedModules){var r=this.loadedModules[i];if(r){var n=r.getModuleName?r.getModuleName():i;s.push(n)}}return this.popNandPushIfOK(t+1,this.makeStObject(s[e]))}},"stack access",{popNIfOK:function(t){return!!this.success&&(this.vm.popN(t),!0)},pop2andPushBoolIfOK:function(t){return this.vm.success=this.success,this.vm.pop2AndPushBoolResult(t)},popNandPushIfOK:function(t,e){return!(!this.success||null==e)&&(this.vm.popNandPush(t,e),!0)},popNandPushIntIfOK:function(t,e){return!(!this.success||!this.vm.canBeSmallInt(e))&&this.popNandPushIfOK(t,e)},popNandPushFloatIfOK:function(t,e){return!!this.success&&this.popNandPushIfOK(t,this.makeFloat(e))},stackNonInteger:function(t){return this.checkNonInteger(this.vm.stackValue(t))},stackInteger:function(t){return this.checkSmallInt(this.vm.stackValue(t))},stackPos32BitInt:function(t){return this.positive32BitValueOf(this.vm.stackValue(t))},pos32BitIntFor:function(t){if(0<=t&&t<=Squeak.MaxSmallInt)return t;for(var e=this.vm.specialObjects[Squeak.splOb_ClassLargePositiveInteger],s=this.vm.instantiateClass(e,4),i=s.bytes,r=0;r<4;r++)i[r]=t>>>8*r&255;return s},pos53BitIntFor:function(t){if(t<=4294967295)return this.pos32BitIntFor(t);if(9007199254740991<t)return console.warn("Out of range: pos53BitIntFor("+t+")"),this.success=!1,0;for(var e=t<=0xffffffffff?5:t<=0xffffffffffff?6:7,s=this.vm.specialObjects[Squeak.splOb_ClassLargePositiveInteger],i=this.vm.instantiateClass(s,e),r=i.bytes,n=0;n<e;n++)r[n]=255&t,t/=256;return i},stackSigned32BitInt:function(t){var e=this.vm.stackValue(t);if("number"==typeof e)return e;if(4!==e.bytesSize())return this.success=!1,0;for(var s=e.bytes,i=0,r=0,n=1;r<4;r++,n*=256)i+=s[r]*n;return this.isA(e,Squeak.splOb_ClassLargePositiveInteger)&&i<=2147483647?i:this.isA(e,Squeak.splOb_ClassLargeNegativeInteger)&&-2147483648<=-i?-i:(this.success=!1,0)},signed32BitIntegerFor:function(t){if(t>=Squeak.MinSmallInt&&t<=Squeak.MaxSmallInt)return t;for(var e=t<0,s=e?-t:t,i=e?Squeak.splOb_ClassLargeNegativeInteger:Squeak.splOb_ClassLargePositiveInteger,r=this.vm.instantiateClass(this.vm.specialObjects[i],4),n=r.bytes,a=0;a<4;a++)n[a]=s>>>8*a&255;return r},stackFloat:function(t){return this.checkFloat(this.vm.stackValue(t))},stackBoolean:function(t){return this.checkBoolean(this.vm.stackValue(t))},stackSigned53BitInt:function(t){var e=this.vm.stackValue(t);if("number"==typeof e)return e;var s=e.bytesSize();if(s<=7){for(var i=e.bytes,r=0,n=0,a=1;n<s;n++,a*=256)r+=i[n]*a;if(r<=9007199254740991){if(this.isA(e,Squeak.splOb_ClassLargePositiveInteger))return r;if(this.isA(e,Squeak.splOb_ClassLargeNegativeInteger))return-r}}return this.success=!1,0}},"numbers",{doBitAnd:function(){var t=this.stackPos32BitInt(1),e=this.stackPos32BitInt(0);return this.success?this.pos32BitIntFor(t&e):0},doBitOr:function(){var t=this.stackPos32BitInt(1),e=this.stackPos32BitInt(0);return this.success?this.pos32BitIntFor(t|e):0},doBitXor:function(){var t=this.stackPos32BitInt(1),e=this.stackPos32BitInt(0);return this.success?this.pos32BitIntFor(t^e):0},doBitShift:function(){var t=this.stackPos32BitInt(1),e=this.stackInteger(0);return this.success?0<this.vm.safeShift(t,e)?this.pos32BitIntFor(this.vm.safeShift(t,e)):(this.success=!1,0):0},safeFDiv:function(t,e){return 0===e?(this.success=!1,1):t/e},floatAsSmallInt:function(t){var e=0<=t?Math.floor(t):Math.ceil(t);return this.ensureSmallInt(e)},frexp_exponent:function(t){if(0==t)return 0;var e=new DataView(new ArrayBuffer(8));e.setFloat64(0,t);var s=e.getUint32(0)>>>20&2047;return 0===s&&(e.setFloat64(0,t*Math.pow(2,64)),s=(e.getUint32(0)>>>20&2047)-64),s-1022},ldexp:function(t,e){for(var s=Math.min(3,Math.ceil(Math.abs(e)/1023)),i=t,r=0;r<s;r++)i*=Math.pow(2,Math.floor((e+r)/s));return i},primitiveLessThanLargeIntegers:function(){return this.pop2andPushBoolIfOK(this.stackSigned53BitInt(1)<this.stackSigned53BitInt(0))},primitiveGreaterThanLargeIntegers:function(){return this.pop2andPushBoolIfOK(this.stackSigned53BitInt(1)>this.stackSigned53BitInt(0))},primitiveLessOrEqualLargeIntegers:function(){return this.pop2andPushBoolIfOK(this.stackSigned53BitInt(1)<=this.stackSigned53BitInt(0))},primitiveGreaterOrEqualLargeIntegers:function(){return this.pop2andPushBoolIfOK(this.stackSigned53BitInt(1)>=this.stackSigned53BitInt(0))},primitiveEqualLargeIntegers:function(){return this.pop2andPushBoolIfOK(this.stackSigned53BitInt(1)===this.stackSigned53BitInt(0))},primitiveNotEqualLargeIntegers:function(){return this.pop2andPushBoolIfOK(this.stackSigned53BitInt(1)!==this.stackSigned53BitInt(0))}},"utils",{floatOrInt:function(t){return t.isFloat?t.float:"number"==typeof t?t:0},positive32BitValueOf:function(t){if("number"==typeof t)return 0<=t?t:(this.success=!1,0);if(!this.isA(t,Squeak.splOb_ClassLargePositiveInteger)||4!==t.bytesSize())return this.success=!1,0;for(var e=t.bytes,s=0,i=0,r=1;i<4;i++,r*=256)s+=e[i]*r;return s},checkFloat:function(t){return t.isFloat?t.float:"number"==typeof t?t:(this.success=!1,0)},checkSmallInt:function(t){return"number"==typeof t?t:(this.success=!1,0)},checkNonInteger:function(t){return"number"!=typeof t?t:(this.success=!1,this.vm.nilObj)},checkBoolean:function(t){return!!t.isTrue||!t.isFalse&&(this.success=!1)},indexableSize:function(t){return"number"==typeof t?-1:t.indexableSize(this)},isA:function(t,e){return t.sqClass===this.vm.specialObjects[e]},isKindOf:function(t,e){for(var s=t.sqClass,i=this.vm.specialObjects[e];!s.isNil;){if(s===i)return!0;s=s.pointers[Squeak.Class_superclass]}return!1},isAssociation:function(t){return"number"!=typeof t&&2==t.pointersSize()},ensureSmallInt:function(t){return t===(0|t)&&this.vm.canBeSmallInt(t)?t:(this.success=!1,0)},charFromInt:function(t){var e=this.vm.specialObjects[Squeak.splOb_CharacterTable].pointers[t];if(e)return e;var s=this.vm.specialObjects[Squeak.splOb_ClassCharacter];return(e=this.vm.instantiateClass(s,0)).pointers[0]=t,e},charFromIntSpur:function(t){return this.vm.image.getCharacter(t)},charToInt:function(t){return t.pointers[0]},charToIntSpur:function(t){return t.hash},makeFloat:function(t){var e=this.vm.specialObjects[Squeak.splOb_ClassFloat],s=this.vm.instantiateClass(e,2);return s.float=t,s},makeLargeIfNeeded:function(t){return this.vm.canBeSmallInt(t)?t:this.makeLargeInt(t)},makeLargeInt:function(t){if(t<0)throw Error("negative large ints not implemented yet");if(4294967295<t)throw Error("large large ints not implemented yet");return this.pos32BitIntFor(t)},makePointWithXandY:function(t,e){var s=this.vm.specialObjects[Squeak.splOb_ClassPoint],i=this.vm.instantiateClass(s,0);return i.pointers[Squeak.Point_x]=t,i.pointers[Squeak.Point_y]=e,i},makeStArray:function(t,e){for(var s=this.vm.instantiateClass(this.vm.specialObjects[Squeak.splOb_ClassArray],t.length),i=0;i<t.length;i++)s.pointers[i]=this.makeStObject(t[i],e);return s},makeStByteArray:function(t){for(var e=this.vm.instantiateClass(this.vm.specialObjects[Squeak.splOb_ClassByteArray],t.length),s=0;s<t.length;s++)e.bytes[s]=255&t[s];return e},makeStString:function(t){for(var e=this.vm.instantiateClass(this.vm.specialObjects[Squeak.splOb_ClassString],t.length),s=0;s<t.length;++s)e.bytes[s]=255&t.charCodeAt(s);return e},makeStObject:function(t,e){if(null==t)return this.vm.nilObj;if(!0===t)return this.vm.trueObj;if(!1===t)return this.vm.falseObj;if(t.sqClass)return t;if("number"==typeof t)return t===(0|t)?this.makeLargeIfNeeded(t):this.makeFloat(t);if(e){var s=this.vm.instantiateClass(e,0);return s.jsObject=t,s}if("string"==typeof t||"Uint8Array"===t.constructor.name)return this.makeStString(t);if("Array"===t.constructor.name)return this.makeStArray(t);throw Error("cannot make smalltalk object")},pointsTo:function(t,e){return!!t.pointers&&0<=t.pointers.indexOf(e)},asUint8Array:function(t){if("Uint8Array"===t.constructor.name)return t;if("ArrayBuffer"===t.constructor.name)return new Uint8Array(t);if("string"!=typeof t)throw Error("unknown buffer type");for(var e=new Uint8Array(t.length),s=0;s<t.length;s++)e[s]=t.charCodeAt(s);return e},filenameToSqueak:function(t){var e="/SqueakJS"+("/"!==t[0]?"/":"")+t;return this.emulateMac&&(e=("Macintosh HD"+e).replace(/\//g,"â‚¬").replace(/:/g,"/").replace(/â‚¬/g,":")),e},filenameFromSqueak:function(t){var e=this.emulateMac?t.replace(/^[^:]*:/,":").replace(/\//g,"â‚¬").replace(/:/g,"/").replace(/â‚¬/g,":"):t;return e=e.replace(/^\/*SqueakJS\/?/,"/")}},"indexing",{objectAt:function(t,e,s){var i,r=this.stackNonInteger(1),n=this.stackPos32BitInt(0);if(!this.success)return r;if(t){if((i=this.atCache[r.hash&this.atCacheMask]).array!==r)return this.success=!1,r}else{if(r.isFloat){var a=r.floatData();return 1==n?this.pos32BitIntFor(a.getUint32(0,!1)):2==n?this.pos32BitIntFor(a.getUint32(4,!1)):(this.success=!1,r)}i=this.makeAtCacheInfo(this.atCache,this.vm.specialSelectors[32],r,e,s)}if(n<1||n>i.size)return this.success=!1,r;if(s)return r.pointers[n-1];if(r.isPointers())return r.pointers[n-1+i.ivarOffset];if(r.isWords())return i.convertChars?this.charFromInt(1073741823&r.words[n-1]):this.pos32BitIntFor(r.words[n-1]);if(r.isBytes())return i.convertChars?this.charFromInt(255&r.bytes[n-1]):255&r.bytes[n-1];var o=4*r.pointersSize();return n-1-o<0?(this.success=!1,r):255&r.bytes[n-1-o]},objectAtPut:function(t,e,s){var i,r=this.stackNonInteger(2),n=this.stackPos32BitInt(1);if(!this.success)return r;if(t){if((i=this.atPutCache[r.hash&this.atCacheMask]).array!==r)return this.success=!1,r}else{if(r.isFloat){var a=this.stackPos32BitInt(0);if(!this.success||1!=n&&2!=n)this.success=!1;else{var o=r.floatData();o.setUint32(1==n?0:4,a,!1),r.float=o.getFloat64(0)}return this.vm.stackValue(0)}i=this.makeAtCacheInfo(this.atPutCache,this.vm.specialSelectors[34],r,e,s)}if(n<1||n>i.size)return this.success=!1,r;var h,c=this.vm.stackValue(0);if(s)return r.dirty=!0,r.pointers[n-1]=c;if(r.isPointers())return r.dirty=!0,r.pointers[n-1+i.ivarOffset]=c;if(r.isWords()){if(e){if(c.sqClass!==this.vm.specialObjects[Squeak.splOb_ClassCharacter])return this.success=!1,c;if("number"!=typeof(h=this.charToInt(c)))return this.success=!1,c}else h=this.stackPos32BitInt(0);return this.success&&(r.words[n-1]=h),c}if(e){if(c.sqClass!==this.vm.specialObjects[Squeak.splOb_ClassCharacter])return this.success=!1,c;if("number"!=typeof(h=this.charToInt(c)))return this.success=!1,c}else{if("number"!=typeof c)return this.success=!1,c;h=c}if(h<0||255<h)return this.success=!1,c;if(r.isBytes())return r.bytes[n-1]=h;var u=4*r.pointersSize();return n-1-u<0?(this.success=!1,r):(r.bytes[n-1-u]=h,c)},objectSize:function(t){var e=this.vm.stackValue(0),s=-1;return t?e.sqClass===this.vm.specialObjects[Squeak.splOb_ClassArray]?s=e.pointersSize():e.sqClass===this.vm.specialObjects[Squeak.splOb_ClassString]&&(s=e.bytesSize()):s=this.indexableSize(e),-1===s?(this.success=!1,-1):this.pos32BitIntFor(s)},initAtCache:function(){this.atCacheSize=32,this.atCacheMask=this.atCacheSize-1,this.atCache=[],this.atPutCache=[],this.nonCachedInfo={};for(var t=0;t<this.atCacheSize;t++)this.atCache.push({}),this.atPutCache.push({})},makeAtCacheInfo:function(t,e,s,i,r){var n;return(n=this.vm.verifyAtSelector===e&&this.vm.verifyAtClass===s.sqClass&&!this.vm.isContext(s)?t[s.hash&this.atCacheMask]:this.nonCachedInfo).array=s,n.convertChars=i,r?(n.size=s.instSize()+Math.max(0,s.indexableSize(this)),n.ivarOffset=0):(n.size=s.indexableSize(this),n.ivarOffset=s.isPointers()?s.instSize():0),n}},"basic",{instantiateClass:function(t,e){return 4*e>this.vm.image.bytesLeft()?(console.warn("squeak: out of memory"),this.success=!1,this.vm.primFailCode=Squeak.PrimErrNoMemory,null):this.vm.instantiateClass(t,e)},someObject:function(){return this.vm.image.firstOldObject},nextObject:function(t){return this.vm.image.objectAfter(t)||0},someInstanceOf:function(t){var e=this.vm.image.someInstanceOf(t);return e||(this.success=!1,0)},nextInstanceAfter:function(t){var e=this.vm.image.nextInstanceAfter(t);return e||(this.success=!1,0)},allInstancesOf:function(t){var e=this.vm.image.allInstancesOf(t),s=this.vm.instantiateClass(this.vm.specialObjects[Squeak.splOb_ClassArray],e.length);return s.pointers=e,s},identityHash:function(t){return t.hash},identityHashSpur:function(t){var e=t.hash;return 0<e?e:t.hash=this.newObjectHash()},behaviorHash:function(t){var e=t.hash;return 0<e?e:this.vm.image.enterIntoClassTable(t)},newObjectHash:function(t){return Math.floor(4194302*Math.random())+1},primitiveSizeInBytesOfInstance:function(t){if(1<t)return!1;var e=this.stackNonInteger(t),s=t?this.stackInteger(0):0,i=e.classByteSizeOfInstance(s);return this.popNandPushIfOK(t+1,this.makeLargeIfNeeded(i))},primitiveSizeInBytes:function(t){var e=this.stackNonInteger(0).totalBytes();return this.popNandPushIfOK(t+1,this.makeLargeIfNeeded(e))},primitiveAsCharacter:function(t){var e=this.stackInteger(0);if(e<0||1073741823<e)return!1;var s=this.charFromInt(e);return!!s&&this.popNandPushIfOK(t+1,s)},primitiveFullGC:function(t){this.vm.image.fullGC("primitive");var e=this.vm.image.bytesLeft();return this.popNandPushIfOK(1,this.makeLargeIfNeeded(e))},primitivePartialGC:function(t){this.vm.image.partialGC("primitive");var e=this.vm.image.bytesLeft();return this.popNandPushIfOK(1,this.makeLargeIfNeeded(e))},primitiveMakePoint:function(t,e){var s=this.vm.stackValue(1),i=this.vm.stackValue(0);return!(e&&(this.checkFloat(s),this.checkFloat(i),!this.success))&&(this.vm.popNandPush(1+t,this.makePointWithXandY(s,i)),!0)},primitiveStoreStackp:function(t){var e=this.stackNonInteger(1),s=this.stackInteger(0);if(!this.success||s<0||this.vm.decodeSqueakSP(s)>=e.pointers.length)return!1;for(var i=e.pointers[Squeak.Context_stackPointer];i<s;)e.pointers[this.vm.decodeSqueakSP(++i)]=this.vm.nilObj;return e.pointers[Squeak.Context_stackPointer]=s,this.vm.popN(t),!0},primitiveChangeClass:function(t){if(2<t)return!1;var e=this.stackNonInteger(1),s=this.stackNonInteger(0);if(!this.success)return!1;if(e.sqClass.isCompact!==s.sqClass.isCompact)return!1;if(e.isPointers()){if(!s.isPointers())return!1;if(e.sqClass.classInstSize()!==s.sqClass.classInstSize())return!1}else{if(s.isPointers())return!1;var i=e.isBytes(),r=s.isBytes();if(i&&!r){if(e.bytes){if(3&e.bytes.length)return!1;e.words=new Uint32Array(e.bytes.buffer),delete e.bytes}}else!i&&r&&e.words&&(e.bytes=new Uint8Array(e.words.buffer),delete e.words)}return e._format=s._format,e.sqClass=s.sqClass,this.popNIfOK(t)},primitiveAdoptInstance:function(t){if(2<t)return!1;var e=this.stackNonInteger(1),s=this.stackNonInteger(0);return!!this.success&&(e.classInstFormat()===s.sqClass.classInstFormat()&&e.isCompact===s.sqClass.isCompact&&e.classInstSize()===s.sqClass.classInstSize()&&(s.sqClass=e,this.popNIfOK(t)))},primitiveDoPrimitiveWithArgs:function(t){var e=this.stackNonInteger(0),s=this.stackInteger(1);if(!this.success)return!1;var i=e.pointersSize(),r=this.vm.activeContext.pointersSize();if(this.vm.sp+i>=r)return!1;this.vm.popN(2);for(var n=0;n<i;n++)this.vm.push(e.pointers[n]);return!!this.vm.tryPrimitive(s,i)||(this.vm.popN(i),this.vm.push(s),this.vm.push(e),!1)},primitiveShortAtAndPut:function(t){var e,s=this.stackNonInteger(t),i=this.stackInteger(t-1)-1,r=s.wordsAsInt16Array();if(!this.success||!r||i<0||i>=r.length)return!1;if(t<2)e=r[i];else{if((e=this.stackInteger(0))<-32768||32767<e)return!1;r[i]=e}return this.popNandPushIfOK(t+1,e),!0},primitiveIntegerAtAndPut:function(t){var e,s=this.stackNonInteger(t),i=this.stackInteger(t-1)-1,r=s.wordsAsInt32Array();if(!this.success||!r||i<0||i>=r.length)return!1;if(t<2)e=this.signed32BitIntegerFor(r[i]);else{if(e=this.stackSigned32BitInt(0),!this.success)return!1;r[i]=e}return this.popNandPushIfOK(t+1,e),!0},primitiveConstantFill:function(t){var e=this.stackNonInteger(1),s=this.stackPos32BitInt(0);if(!this.success||!e.isWordsOrBytes())return!1;var i=e.words||e.bytes;if(i){if(i===e.bytes&&255<s)return!1;for(var r=0;r<i.length;r++)i[r]=s}return this.vm.popN(t),!0},primitiveNewMethod:function(t){var e=this.stackInteger(0),s=this.stackInteger(1);if(!this.success)return 0;var i=this.vm.instantiateClass(this.vm.stackValue(2),s);i.pointers=[e];for(var r=i.methodNumLits(),n=0;n<r;n++)i.pointers.push(this.vm.nilObj);return this.vm.popNandPush(1+t,i),this.vm.breakOnNewMethod&&(this.vm.breakOnMethod=i),!0},primitiveExecuteMethodArgsArray:function(t){var e=this.stackNonInteger(0),s=this.stackNonInteger(1),i=this.vm.stackValue(2);if(!this.success||!e.isMethod()||4<t)return!1;var r=e.methodNumArgs();if(r!==s.pointersSize())return!1;this.vm.popNandPush(t+1,i);for(var n=0;n<r;n++)this.vm.push(s.pointers[n]);return this.vm.executeNewMethod(i,e,r,e.methodPrimitiveIndex(),null,null),!0},primitiveArrayBecome:function(t,e){var s=this.stackNonInteger(t),i=this.stackNonInteger(t-1),r=!(1<t)||this.stackBoolean(t-2);return!!this.success&&(this.success=this.vm.image.bulkBecome(s.pointers,i.pointers,e,r),this.popNIfOK(t))},doStringReplace:function(){var t=this.stackNonInteger(4),e=this.stackInteger(3)-1,s=this.stackInteger(2)-e,i=this.stackNonInteger(1),r=this.stackInteger(0)-1;if(!this.success)return t;if(!i.sameFormatAs(t))return this.success=!1,t;if(i.isPointers()){var n=i.pointersSize();if((r+=i.instSize())<0||n<r+s)return this.success=!1,t;if(n=t.pointersSize(),(e+=t.instSize())<0||n<e+s)return this.success=!1,t;for(var a=0;a<s;a++)t.pointers[e+a]=i.pointers[r+a];return t}if(i.isWords()){n=i.wordsSize();if(r<0||n<r+s)return this.success=!1,t;if(n=t.wordsSize(),e<0||n<e+s)return this.success=!1,t;if(i.isFloat&&t.isFloat)t.float=i.float;else if(i.isFloat)t.wordsAsFloat64Array()[e]=i.float;else if(t.isFloat)t.float=i.wordsAsFloat64Array()[r];else for(a=0;a<s;a++)t.words[e+a]=i.words[r+a];return t}n=i.bytesSize();if(r<0||n<r+s)return this.success=!1,t;if(n=t.bytesSize(),e<0||n<e+s)return this.success=!1,t;for(a=0;a<s;a++)t.bytes[e+a]=i.bytes[r+a];return t},primitiveCopyObject:function(t){var e=this.stackNonInteger(1),s=this.stackNonInteger(0),i=e.pointersSize();if(!this.success||e.isWordsOrBytes()||e.sqClass!==s.sqClass||i!==s.pointersSize())return!1;for(var r=0;r<i;r++)e.pointers[r]=s.pointers[r];return e.dirty=s.dirty,this.vm.pop(t),!0},primitiveLoadImageSegment:function(t){var e=this.stackNonInteger(1),s=this.stackNonInteger(0);if(!e.words||!s.pointers)return!1;var i=this.vm.image.loadImageSegment(e,s);return!!i&&this.popNandPushIfOK(t+1,i)}},"blocks/closures",{doBlockCopy:function(){var t=this.vm.stackValue(1),e=this.stackInteger(0),s=t;if(this.vm.isContext(s)||(this.success=!1),!this.success)return t;"number"==typeof s.pointers[Squeak.Context_method]&&(s=s.pointers[Squeak.BlockContext_home]);var i=s.pointersSize()-s.instSize(),r=this.vm.instantiateClass(this.vm.specialObjects[Squeak.splOb_ClassBlockContext],i),n=this.vm.encodeSqueakPC(this.vm.pc+2,this.vm.method);return r.pointers[Squeak.BlockContext_initialIP]=n,r.pointers[Squeak.Context_instructionPointer]=n,r.pointers[Squeak.Context_stackPointer]=0,r.pointers[Squeak.BlockContext_argumentCount]=e,r.pointers[Squeak.BlockContext_home]=s,r.pointers[Squeak.Context_sender]=this.vm.nilObj,r},primitiveBlockValue:function(t){var e=this.vm.stackValue(t);if(!this.isA(e,Squeak.splOb_ClassBlockContext))return!1;var s=e,i=s.pointers[Squeak.BlockContext_argumentCount];if("number"!=typeof i)return!1;if(i!=t)return!1;if(!s.pointers[Squeak.BlockContext_caller].isNil)return!1;this.vm.arrayCopy(this.vm.activeContext.pointers,this.vm.sp-t+1,s.pointers,Squeak.Context_tempFrameStart,t);var r=s.pointers[Squeak.BlockContext_initialIP];return s.pointers[Squeak.Context_instructionPointer]=r,s.pointers[Squeak.Context_stackPointer]=t,s.pointers[Squeak.BlockContext_caller]=this.vm.activeContext,this.vm.popN(t+1),this.vm.newActiveContext(s),!0},primitiveBlockValueWithArgs:function(t){var e=this.vm.stackValue(1),s=this.vm.stackValue(0);if(!this.isA(e,Squeak.splOb_ClassBlockContext))return!1;if(!this.isA(s,Squeak.splOb_ClassArray))return!1;var i=e.pointers[Squeak.BlockContext_argumentCount];if("number"!=typeof i)return!1;if(i!=s.pointersSize())return!1;if(!e.pointers[Squeak.BlockContext_caller].isNil)return!1;this.vm.arrayCopy(s.pointers,0,e.pointers,Squeak.Context_tempFrameStart,i);var r=e.pointers[Squeak.BlockContext_initialIP];return e.pointers[Squeak.Context_instructionPointer]=r,e.pointers[Squeak.Context_stackPointer]=i,e.pointers[Squeak.BlockContext_caller]=this.vm.activeContext,this.vm.popN(t+1),this.vm.newActiveContext(e),!0},primitiveClosureCopyWithCopiedValues:function(t){return this.vm.breakNow("primitiveClosureCopyWithCopiedValues"),!1},primitiveClosureValue:function(t){var e=this.vm.stackValue(t);return t===e.pointers[Squeak.Closure_numArgs]&&this.activateNewClosureMethod(e,t)},primitiveClosureValueWithArgs:function(t){var e=this.vm.top(),s=e.pointersSize(),i=this.vm.stackValue(t);if(s!==i.pointers[Squeak.Closure_numArgs])return!1;this.vm.pop();for(var r=0;r<s;r++)this.vm.push(e.pointers[r]);return this.activateNewClosureMethod(i,s)},primitiveClosureValueNoContextSwitch:function(t){return this.primitiveClosureValue(t)},activateNewClosureMethod:function(t,e){var s=t.pointers[Squeak.Closure_outerContext],i=s.pointers[Squeak.Context_method],r=this.vm.allocateOrRecycleContext(i.methodNeedsLargeFrame()),n=t.pointers.length-Squeak.Closure_firstCopiedValue;r.pointers[Squeak.Context_sender]=this.vm.activeContext,r.pointers[Squeak.Context_instructionPointer]=t.pointers[Squeak.Closure_startpc],r.pointers[Squeak.Context_stackPointer]=e+n,r.pointers[Squeak.Context_method]=s.pointers[Squeak.Context_method],r.pointers[Squeak.Context_closure]=t,r.pointers[Squeak.Context_receiver]=s.pointers[Squeak.Context_receiver];for(var a=Squeak.Context_tempFrameStart,o=0;o<e;o++)r.pointers[a++]=this.vm.stackValue(e-o-1);for(o=0;o<n;o++)r.pointers[a++]=t.pointers[Squeak.Closure_firstCopiedValue+o];return this.vm.popN(e+1),this.vm.newActiveContext(r),!0}},"scheduling",{primitiveResume:function(){return this.resume(this.vm.top()),!0},primitiveSuspend:function(){var t=this.vm.top();if(t===this.activeProcess())this.vm.popNandPush(1,this.vm.nilObj),this.transferTo(this.wakeHighestPriority());else{var e=t.pointers[Squeak.Proc_myList];if(e.isNil)return!1;if(this.removeProcessFromList(t,e),!this.success)return!1;t.pointers[Squeak.Proc_myList]=this.vm.nilObj,this.vm.popNandPush(1,e)}return!0},getScheduler:function(){return this.vm.specialObjects[Squeak.splOb_SchedulerAssociation].pointers[Squeak.Assn_value]},activeProcess:function(){return this.getScheduler().pointers[Squeak.ProcSched_activeProcess]},resume:function(t){var e=this.activeProcess();e.pointers[Squeak.Proc_priority]<t.pointers[Squeak.Proc_priority]?(this.putToSleep(e),this.transferTo(t)):this.putToSleep(t)},putToSleep:function(t){var e=t.pointers[Squeak.Proc_priority],s=this.getScheduler().pointers[Squeak.ProcSched_processLists].pointers[e-1];this.linkProcessToList(t,s)},transferTo:function(t){var e=this.getScheduler(),s=e.pointers[Squeak.ProcSched_activeProcess];e.pointers[Squeak.ProcSched_activeProcess]=t,e.dirty=!0,s.pointers[Squeak.Proc_suspendedContext]=this.vm.activeContext,s.dirty=!0,this.vm.newActiveContext(t.pointers[Squeak.Proc_suspendedContext]),t.pointers[Squeak.Proc_suspendedContext]=this.vm.nilObj,this.vm.reclaimableContextCount=0,this.vm.breakOnContextChanged&&(this.vm.breakOnContextChanged=!1,this.vm.breakNow())},wakeHighestPriority:function(){var t,e=this.getScheduler().pointers[Squeak.ProcSched_processLists],s=e.pointersSize()-1;do{if(s<0)throw Error("scheduler could not find a runnable process");t=e.pointers[s--]}while(this.isEmptyList(t));return this.removeFirstLinkOfList(t)},linkProcessToList:function(t,e){if(this.isEmptyList(e))e.pointers[Squeak.LinkedList_firstLink]=t;else{var s=e.pointers[Squeak.LinkedList_lastLink];s.pointers[Squeak.Link_nextLink]=t,s.dirty=!0}e.pointers[Squeak.LinkedList_lastLink]=t,e.dirty=!0,t.pointers[Squeak.Proc_myList]=e,t.dirty=!0},isEmptyList:function(t){return t.pointers[Squeak.LinkedList_firstLink].isNil},removeFirstLinkOfList:function(t){var e=t.pointers[Squeak.LinkedList_firstLink];if(e===t.pointers[Squeak.LinkedList_lastLink])t.pointers[Squeak.LinkedList_firstLink]=this.vm.nilObj,t.pointers[Squeak.LinkedList_lastLink]=this.vm.nilObj;else{var s=e.pointers[Squeak.Link_nextLink];t.pointers[Squeak.LinkedList_firstLink]=s,t.dirty=!0}return e.pointers[Squeak.Link_nextLink]=this.vm.nilObj,e},removeProcessFromList:function(t,e){var s=e.pointers[Squeak.LinkedList_firstLink],i=e.pointers[Squeak.LinkedList_lastLink];if(t===s){var r=t.pointers[Squeak.Link_nextLink];e.pointers[Squeak.LinkedList_firstLink]=r,t===i&&(e.pointers[Squeak.LinkedList_lastLink]=this.vm.nilObj)}else{for(var n=s;;){if(n.isNil)return this.success=!1;if((r=n.pointers[Squeak.Link_nextLink])===t)break;n=r}r=t.pointers[Squeak.Link_nextLink],n.pointers[Squeak.Link_nextLink]=r,t===i&&(e.pointers[Squeak.LinkedList_lastLink]=n)}t.pointers[Squeak.Link_nextLink]=this.vm.nilObj},registerSemaphore:function(t){var e=this.vm.top();return this.isA(e,Squeak.splOb_ClassSemaphore)?this.vm.specialObjects[t]=e:this.vm.specialObjects[t]=this.vm.nilObj,this.vm.stackValue(1)},primitiveWait:function(){var t=this.vm.top();if(!this.isA(t,Squeak.splOb_ClassSemaphore))return!1;var e=t.pointers[Squeak.Semaphore_excessSignals];return 0<e?t.pointers[Squeak.Semaphore_excessSignals]=e-1:(this.linkProcessToList(this.activeProcess(),t),this.transferTo(this.wakeHighestPriority())),!0},primitiveSignal:function(){var t=this.vm.top();return!!this.isA(t,Squeak.splOb_ClassSemaphore)&&(this.synchronousSignal(t),!0)},synchronousSignal:function(t){this.isEmptyList(t)?t.pointers[Squeak.Semaphore_excessSignals]++:this.resume(this.removeFirstLinkOfList(t))},signalAtMilliseconds:function(t,e){this.isA(t,Squeak.splOb_ClassSemaphore)?(this.vm.specialObjects[Squeak.splOb_TheTimerSemaphore]=t,this.vm.nextWakeupTick=e):(this.vm.specialObjects[Squeak.splOb_TheTimerSemaphore]=this.vm.nilObj,this.vm.nextWakeupTick=0)},primitiveSignalAtMilliseconds:function(t){var e=this.stackInteger(0),s=this.stackNonInteger(1);return!!this.success&&(this.signalAtMilliseconds(s,e),this.vm.popN(t),!0)},primitiveSignalAtUTCMicroseconds:function(t){var e=this.stackSigned53BitInt(0),s=this.stackNonInteger(1);if(!this.success)return!1;var i=e/1e3+Squeak.EpochUTC-this.vm.startupTime&Squeak.MillisecondClockMask;return this.signalAtMilliseconds(s,i),this.vm.popN(t),!0},signalSemaphoreWithIndex:function(t){this.semaphoresToSignal.push(t)},signalExternalSemaphores:function(){for(var t=this.vm.specialObjects[Squeak.splOb_ExternalObjectsArray].pointers,e=this.vm.specialObjects[Squeak.splOb_ClassSemaphore];this.semaphoresToSignal.length;){var s=t[this.semaphoresToSignal.shift()-1];s.sqClass==e&&this.synchronousSignal(s)}},primitiveEnterCriticalSection:function(t){if(1<t)return!1;var e=this.vm.stackValue(t),s=t?this.vm.top():this.activeProcess(),i=e.pointers[Squeak.Mutex_owner];return i.isNil?(e.pointers[Squeak.Mutex_owner]=s,e.dirty=!0,this.popNandPushIfOK(t+1,this.vm.falseObj)):i===s?this.popNandPushIfOK(t+1,this.vm.trueObj):(this.popNandPushIfOK(t+1,this.vm.falseObj),this.linkProcessToList(s,e),this.transferTo(this.wakeHighestPriority())),!0},primitiveExitCriticalSection:function(t){var e=this.vm.top();if(this.isEmptyList(e))e.pointers[Squeak.Mutex_owner]=this.vm.nilObj;else{var s=this.removeFirstLinkOfList(e);e.pointers[Squeak.Mutex_owner]=s,e.dirty=!0,this.resume(s)}return!0},primitiveTestAndSetOwnershipOfCriticalSection:function(t){if(1<t)return!1;var e=this.vm.stackValue(t),s=t?this.vm.top():this.activeProcess(),i=e.pointers[Squeak.Mutex_owner];return i.isNil?(e.pointers[Squeak.Mutex_owner]=s,e.dirty=!0,this.popNandPushIfOK(t+1,this.vm.falseObj)):i===s?this.popNandPushIfOK(t+1,this.vm.trueObj):this.popNandPushIfOK(t+1,this.vm.nilObj),!0}},"vm functions",{primitiveGetAttribute:function(t){var e=this.stackInteger(0);if(!this.success)return!1;var s=this.display.argv,i=this.display.vmOptions,r=null;switch(e){case 0:r=s&&s[0]||this.filenameToSqueak(Squeak.vmPath+Squeak.vmFile);break;case 1:r=s&&s[1]||this.display.documentName;break;case 2:r=s&&s[2]||this.display.documentName;break;case 1001:r=Squeak.platformName;break;case 1002:r=Squeak.osVersion;break;case 1003:r=Squeak.platformSubtype;break;case 1004:r=Squeak.vmVersion;break;case 1005:r=Squeak.windowSystem;break;case 1006:r=Squeak.vmBuild;break;case 1007:r=Squeak.vmVersion;break;case 1009:r=Squeak.vmVersion+" Date: "+Squeak.vmDate;break;default:if(0<=e&&s&&s.length>e)r=s[e];else{if(!(e<0&&i&&i.length>-e-1))return!1;r=i[-e-1]}}return this.vm.popNandPush(t+1,this.makeStObject(r)),!0},setLowSpaceThreshold:function(){var t=this.stackInteger(0);return this.success&&(this.vm.lowSpaceThreshold=t),this.vm.stackValue(1)},primitiveVMParameter:function(t){var e=this.vm.image.isSpur?71:44;switch(t){case 0:for(var s=this.vm.instantiateClass(this.vm.specialObjects[Squeak.splOb_ClassArray],e),i=0;i<e;i++)s.pointers[i]=this.makeStObject(this.vmParameterAt(i+1));return this.popNandPushIfOK(1,s);case 1:var r=this.stackInteger(0);return r<1||e<r?!1:this.popNandPushIfOK(2,this.makeStObject(this.vmParameterAt(r)));case 2:return this.popNandPushIfOK(3,0)}return!1},vmParameterAt:function(t){switch(t){case 1:case 2:return this.vm.image.oldSpaceBytes;case 3:return this.vm.image.totalMemory;case 4:return this.vm.image.allocationCount+this.vm.image.newSpaceCount;case 7:return this.vm.image.gcCount;case 8:return this.vm.image.gcMilliseconds;case 9:return this.vm.image.pgcCount;case 10:return this.vm.image.pgcMilliseconds;case 11:return this.vm.image.gcTenured;case 15:case 16:case 17:case 22:return 0;case 23:return this.vm.image.extraVMMemory;case 40:return 4;case 41:return this.vm.image.formatVersion();case 44:case 46:case 48:return 0;case 54:return this.vm.image.bytesLeft();case 65:return 0}return null},primitiveImageName:function(t){return 0==t?this.popNandPushIfOK(1,this.makeStString(this.filenameToSqueak(this.vm.image.name))):(this.vm.image.name=this.filenameFromSqueak(this.vm.top().bytesAsString()),Squeak.Settings.squeakImageName=this.vm.image.name,!0)},primitiveSnapshot:function(t){this.vm.popNandPush(1,this.vm.trueObj),this.vm.storeContextRegisters(),this.activeProcess().pointers[Squeak.Proc_suspendedContext]=this.vm.activeContext,this.vm.image.fullGC("snapshot");var e=this.vm.image.writeToBuffer();return Squeak.flushAllFiles&&(Squeak.flushAllFiles(),Squeak.filePut(this.vm.image.name,e)),this.vm.popNandPush(1,this.vm.falseObj),!0},primitiveQuit:function(t){return Squeak.flushAllFiles&&Squeak.flushAllFiles(),this.display.quitFlag=!0,this.vm.breakNow("quit"),!0},primitiveExitToDebugger:function(t){return this.vm.breakNow("debugger primitive"),!0},primitiveSetGCBiasToGrow:function(t){return this.fakePrimitive(".primitiveSetGCBiasToGrow",0,t)},primitiveSetGCBiasToGrowGCLimit:function(t){return this.fakePrimitive(".primitiveSetGCBiasToGrowGCLimit",0,t)}},"time",{primitiveRelinquishProcessorForMicroseconds:function(t){return this.vm.pop(t),this.vm.goIdle(),!0},millisecondClockValue:function(){return Date.now()-this.vm.startupTime&Squeak.MillisecondClockMask},millisecondClockValueSet:function(t){this.vm.startupTime=Date.now()-t},secondClock:function(){return this.pos32BitIntFor(Squeak.totalSeconds())},microsecondClock:function(t){var e=Date.now()-t.epoch;if("object"!=typeof performance)return this.pos53BitIntFor(1e3*e);var s=1e3*performance.now()%1e3|0,i=t.millis,r=t.micros;return e<i&&(e=i),e===i&&s<r&&e++,t.millis=e,t.micros=s,this.pos53BitIntFor(1e3*e+s)},microsecondClockUTC:function(){return this.microsecondClockUTCState||(this.microsecondClockUTCState={epoch:Squeak.EpochUTC,millis:0,micros:0}),this.microsecondClock(this.microsecondClockUTCState)},microsecondClockLocal:function(){return this.microsecondClockLocalState||(this.microsecondClockLocalState={epoch:Squeak.Epoch,millis:0,micros:0}),this.microsecondClock(this.microsecondClockLocalState)},primitiveUtcWithOffset:function(t){var e=new Date,s=this.pos53BitIntFor(1e3*e.getTime()),i=-60*e.getTimezoneOffset();if(0<t){var r=this.vm.stackValue(0);return r.pointers[0]=s,r.pointers[1]=i,this.popNandPushIfOK(t+1,r),!0}var n=[s,i];return this.popNandPushIfOK(t+1,this.makeStArray(n)),!0}}),Object.subclass("Squeak.Compiler","initialization",{initialize:function(t){this.vm=t,this.comments=!!Squeak.Compiler.comments,this.specialSelectors=["+","-","<",">","<=",">=","=","~=","*","/","\\","@","bitShift:","//","bitAnd:","bitOr:","at:","at:put:","size","next","nextPut:","atEnd","==","class","blockCopy:","value","value:","do:","new","new:","x","y"]}},"accessing",{compile:function(t,e,s){if(void 0===t.compiled)t.compiled=!1;else{this.singleStep=!1,this.debug=this.comments;var i=e&&e.className(),r=s&&s.bytesAsString();t.compiled=this.generate(t,i,r)}},enableSingleStepping:function(i,r,n){if(!i.compiled||!i.compiled.canSingleStep){this.singleStep=!0,this.debug=!0,r||this.vm.allMethodsDo(function(t,e,s){if(e===i)return r=t,n=s,!0});var t=r&&r.className(),e=n&&n.bytesAsString(),s=r&&r.allInstVarNames();i.compiled=this.generate(i,t,e,s),i.compiled.canSingleStep=!0}return!0},functionNameFor:function(t,e){if(void 0===t||"?"===t)return"Squeak_DOIT";if(!/[^a-zA-Z0-9:_]/.test(e))return(t+"_"+e).replace(/[: ]/g,"_");var s=e.replace(/./g,function(t){return{"|":"OR","~":"NOT","<":"LT","=":"EQ",">":"GT","&":"AND","@":"AT","*":"TIMES","+":"PLUS","\\":"MOD","-":"MINUS",",":"COMMA","/":"DIV","?":"IF"}[t]||"OPERATOR"});return t.replace(/[ ]/,"_")+"__"+s+"__"}},"generating",{generate:function(t,e,s,i){for(this.method=t,this.pc=0,this.endPC=0,this.prevPC=0,this.source=[],this.sourceLabels={},this.needsLabel={},this.sourcePos={},this.needsVar={},this.needsBreak=!1,e&&s&&this.source.push("// ",e,">>",s,"\n"),this.instVarNames=i,this.allVars=["context","stack","rcvr","inst[","temp[","lit["],this.sourcePos.context=this.source.length,this.source.push("var context = vm.activeContext;\n"),this.sourcePos.stack=this.source.length,this.source.push("var stack = context.pointers;\n"),this.sourcePos.rcvr=this.source.length,this.source.push("var rcvr = vm.receiver;\n"),this.sourcePos["inst["]=this.source.length,this.source.push("var inst = rcvr.pointers;\n"),this.sourcePos["temp["]=this.source.length,this.source.push("var temp = vm.homeContext.pointers;\n"),this.sourcePos["lit["]=this.source.length,this.source.push("var lit = vm.method.pointers;\n"),this.sourcePos["loop-start"]=this.source.length,this.source.push("while (true) switch (vm.pc) {\ncase 0:\n"),this.done=!1;!this.done;){var r=t.bytes[this.pc++],n=0;switch(248&r){case 0:case 8:this.generatePush("inst[",15&r,"]");break;case 16:case 24:this.generatePush("temp[",6+(15&r),"]");break;case 32:case 40:case 48:case 56:this.generatePush("lit[",1+(31&r),"]");break;case 64:case 72:case 80:case 88:this.generatePush("lit[",1+(31&r),"].pointers[1]");break;case 96:this.generatePopInto("inst[",7&r,"]");break;case 104:this.generatePopInto("temp[",6+(7&r),"]");break;case 112:switch(r){case 112:this.generatePush("rcvr");break;case 113:this.generatePush("vm.trueObj");break;case 114:this.generatePush("vm.falseObj");break;case 115:this.generatePush("vm.nilObj");break;case 116:this.generatePush("-1");break;case 117:this.generatePush("0");break;case 118:this.generatePush("1");break;case 119:this.generatePush("2")}break;case 120:switch(r){case 120:this.generateReturn("rcvr");break;case 121:this.generateReturn("vm.trueObj");break;case 122:this.generateReturn("vm.falseObj");break;case 123:this.generateReturn("vm.nilObj");break;case 124:this.generateReturn("stack[vm.sp]");break;case 125:this.generateBlockReturn();break;default:throw Error("unusedBytecode")}break;case 128:case 136:this.generateExtended(r);break;case 144:this.generateJump(1+(7&r));break;case 152:this.generateJumpIf(!1,1+(7&r));break;case 160:n=t.bytes[this.pc++],this.generateJump(256*((7&r)-4)+n);break;case 168:n=t.bytes[this.pc++],this.generateJumpIf(r<172,256*(3&r)+n);break;case 176:case 184:this.generateNumericOp(r);break;case 192:case 200:this.generateQuickPrim(r);break;case 208:case 216:this.generateSend("lit[",1+(15&r),"]",0,!1);break;case 224:case 232:this.generateSend("lit[",1+(15&r),"]",1,!1);break;case 240:case 248:this.generateSend("lit[",1+(15&r),"]",2,!1)}}var a=this.functionNameFor(e,s);return this.singleStep?(this.debug&&this.source.push("// all valid PCs have a label;\n"),this.source.push("default: throw Error('invalid PC');\n}")):(this.sourcePos["loop-end"]=this.source.length,this.source.push("default: vm.interpretOne(true); return;\n}"),this.deleteUnneededLabels()),this.deleteUnneededVariables(),new Function("'use strict';\nreturn function "+a+"(vm) {\n"+this.source.join("")+"}")()},generateExtended:function(t){var e,s;switch(t){case 128:switch((e=this.method.bytes[this.pc++])>>6){case 0:return void this.generatePush("inst[",63&e,"]");case 1:return void this.generatePush("temp[",6+(63&e),"]");case 2:return void this.generatePush("lit[",1+(63&e),"]");case 3:return void this.generatePush("lit[",1+(63&e),"].pointers[1]")}case 129:switch((e=this.method.bytes[this.pc++])>>6){case 0:return void this.generateStoreInto("inst[",63&e,"]");case 1:return void this.generateStoreInto("temp[",6+(63&e),"]");case 2:throw Error("illegal store into literal");case 3:return void this.generateStoreInto("lit[",1+(63&e),"].pointers[1]")}return;case 130:switch((e=this.method.bytes[this.pc++])>>6){case 0:return void this.generatePopInto("inst[",63&e,"]");case 1:return void this.generatePopInto("temp[",6+(63&e),"]");case 2:throw Error("illegal pop into literal");case 3:return void this.generatePopInto("lit[",1+(63&e),"].pointers[1]")}case 131:return e=this.method.bytes[this.pc++],void this.generateSend("lit[",1+(31&e),"]",e>>5,!1);case 132:switch(e=this.method.bytes[this.pc++],s=this.method.bytes[this.pc++],e>>5){case 0:return void this.generateSend("lit[",1+s,"]",31&e,!1);case 1:return void this.generateSend("lit[",1+s,"]",31&e,!0);case 2:return void this.generatePush("inst[",s,"]");case 3:return void this.generatePush("lit[",1+s,"]");case 4:return void this.generatePush("lit[",1+s,"].pointers[1]");case 5:return void this.generateStoreInto("inst[",s,"]");case 6:return void this.generatePopInto("inst[",s,"]");case 7:return void this.generateStoreInto("lit[",1+s,"].pointers[1]")}case 133:return e=this.method.bytes[this.pc++],void this.generateSend("lit[",1+(31&e),"]",e>>5,!0);case 134:return e=this.method.bytes[this.pc++],void this.generateSend("lit[",1+(63&e),"]",e>>6,!1);case 135:return void this.generateInstruction("pop","vm.sp--");case 136:return this.needsVar.stack=!0,void this.generateInstruction("dup","var dup = stack[vm.sp]; stack[++vm.sp] = dup");case 137:return this.needsVar.stack=!0,void this.generateInstruction("push thisContext","stack[++vm.sp] = vm.exportThisContext()");case 138:var i=127<(e=this.method.bytes[this.pc++]),r=127&e;return void this.generateClosureTemps(r,i);case 139:return e=this.method.bytes[this.pc++],s=this.method.bytes[this.pc++],void this.generateCallPrimitive(e+256*s);case 140:return e=this.method.bytes[this.pc++],s=this.method.bytes[this.pc++],void this.generatePush("temp[",6+s,"].pointers[",e,"]");case 141:return e=this.method.bytes[this.pc++],s=this.method.bytes[this.pc++],void this.generateStoreInto("temp[",6+s,"].pointers[",e,"]");case 142:return e=this.method.bytes[this.pc++],s=this.method.bytes[this.pc++],void this.generatePopInto("temp[",6+s,"].pointers[",e,"]");case 143:var n=15&(e=this.method.bytes[this.pc++]),a=e>>4,o=(s=this.method.bytes[this.pc++])<<8|this.method.bytes[this.pc++];return void this.generateClosureCopy(n,a,o)}},generatePush:function(t,e,s,i,r){this.debug&&this.generateDebugCode("push",t,e,s,i,r),this.generateLabel(),this.needsVar[t]=!0,this.needsVar.stack=!0,this.source.push("stack[++vm.sp] = ",t),void 0!==e&&(this.source.push(e,s),void 0!==i&&this.source.push(i,r)),this.source.push(";\n")},generateStoreInto:function(t,e,s,i,r){this.debug&&this.generateDebugCode("store into",t,e,s,i,r),this.generateLabel(),this.needsVar[t]=!0,this.needsVar.stack=!0,this.source.push(t),void 0!==e&&(this.source.push(e,s),void 0!==i&&this.source.push(i,r)),this.source.push(" = stack[vm.sp];\n"),this.generateDirty(t,e)},generatePopInto:function(t,e,s,i,r){this.debug&&this.generateDebugCode("pop into",t,e,s,i,r),this.generateLabel(),this.needsVar[t]=!0,this.needsVar.stack=!0,this.source.push(t),void 0!==e&&(this.source.push(e,s),void 0!==i&&this.source.push(i,r)),this.source.push(" = stack[vm.sp--];\n"),this.generateDirty(t,e)},generateReturn:function(t){this.debug&&this.generateDebugCode("return",t),this.generateLabel(),this.needsVar[t]=!0,this.source.push("vm.pc = ",this.pc,"; vm.doReturn(",t,"); return;\n"),this.needsBreak=!1,this.done=this.pc>this.endPC},generateBlockReturn:function(){this.debug&&this.generateDebugCode("block return"),this.generateLabel(),this.needsVar.stack=!0,this.source.push("vm.pc = ",this.pc,"; vm.doReturn(stack[vm.sp--], context.pointers[0]); return;\n"),this.needsBreak=!1},generateJump:function(t){var e=this.pc+t;this.debug&&this.generateDebugCode("jump to "+e),this.generateLabel(),this.needsVar.context=!0,this.source.push("vm.pc = ",e,"; "),t<0&&this.source.push("\nif (vm.interruptCheckCounter-- <= 0) {\n","   vm.checkForInterrupts();\n","   if (context !== vm.activeContext || vm.breakOutOfInterpreter !== false) return;\n","}\n"),this.singleStep&&this.source.push("\nif (vm.breakOutOfInterpreter) return;\n"),this.source.push("continue;\n"),this.needsBreak=!1,this.needsLabel[e]=!0,e>this.endPC&&(this.endPC=e)},generateJumpIf:function(t,e){var s=this.pc+e;this.debug&&this.generateDebugCode("jump if "+t+" to "+s),this.generateLabel(),this.needsVar.stack=!0,this.source.push("var cond = stack[vm.sp--]; if (cond === vm.",t,"Obj) {vm.pc = ",s,"; "),this.singleStep&&this.source.push("if (vm.breakOutOfInterpreter) return; else "),this.source.push("continue}\n","else if (cond !== vm.",!t,"Obj) {vm.sp++; vm.pc = ",this.pc,"; vm.send(vm.specialObjects[25], 0, false); return}\n"),this.needsLabel[this.pc]=!0,this.needsLabel[s]=!0,s>this.endPC&&(this.endPC=s)},generateQuickPrim:function(t){switch(this.debug&&this.generateDebugCode("quick prim "+this.specialSelectors[16+(15&t)]),this.generateLabel(),t){case 194:return this.needsVar.stack=!0,this.source.push("if (stack[vm.sp].sqClass === vm.specialObjects[7]) stack[vm.sp] = stack[vm.sp].pointersSize();\n","else if (stack[vm.sp].sqClass === vm.specialObjects[6]) stack[vm.sp] = stack[vm.sp].bytesSize();\n","else { vm.pc = ",this.pc,"; vm.sendSpecial(18); if (context !== vm.activeContext || vm.breakOutOfInterpreter !== false) return; }\n"),void(this.needsLabel[this.pc]=!0);case 198:return this.needsVar.stack=!0,void this.source.push("var cond = stack[vm.sp-1] === stack[vm.sp];\nstack[--vm.sp] = cond ? vm.trueObj : vm.falseObj;\n");case 199:return this.needsVar.stack=!0,void this.source.push("stack[vm.sp] = typeof stack[vm.sp] === 'number' ? vm.specialObjects[5] : stack[vm.sp].sqClass;\n");case 200:return this.needsVar.rcvr=!0,this.source.push("vm.pc = ",this.pc,"; if (!vm.primHandler.quickSendOther(rcvr, ",15&t,")) ","{vm.sendSpecial(",16+(15&t),"); return}\n"),this.needsLabel[this.pc]=!0,void(this.needsLabel[this.pc+2]=!0);case 201:case 202:case 203:return this.needsVar.rcvr=!0,this.source.push("vm.pc = ",this.pc,"; if (!vm.primHandler.quickSendOther(rcvr, ",15&t,")) vm.sendSpecial(",16+(15&t),"); return;\n"),void(this.needsLabel[this.pc]=!0)}this.needsVar.rcvr=!0,this.needsVar.context=!0,this.source.push("vm.pc = ",this.pc,"; if (!vm.primHandler.quickSendOther(rcvr, ",15&t,"))"," vm.sendSpecial(",16+(15&t),");\n","if (context !== vm.activeContext || vm.breakOutOfInterpreter !== false) return;\n"),this.needsBreak=!1,this.needsLabel[this.pc]=!0},generateNumericOp:function(t){switch(this.debug&&this.generateDebugCode("numeric op "+this.specialSelectors[15&t]),this.generateLabel(),this.needsLabel[this.pc]=!0,t){case 176:return this.needsVar.stack=!0,void this.source.push("var a = stack[vm.sp - 1], b = stack[vm.sp];\n","if (typeof a === 'number' && typeof b === 'number') {\n","   stack[--vm.sp] = vm.primHandler.signed32BitIntegerFor(a + b);\n","} else { vm.pc = ",this.pc,"; vm.sendSpecial(0); if (context !== vm.activeContext || vm.breakOutOfInterpreter !== false) return}\n");case 177:return this.needsVar.stack=!0,void this.source.push("var a = stack[vm.sp - 1], b = stack[vm.sp];\n","if (typeof a === 'number' && typeof b === 'number') {\n","   stack[--vm.sp] = vm.primHandler.signed32BitIntegerFor(a - b);\n","} else { vm.pc = ",this.pc,"; vm.sendSpecial(1); if (context !== vm.activeContext || vm.breakOutOfInterpreter !== false) return}\n");case 178:return this.needsVar.stack=!0,void this.source.push("var a = stack[vm.sp - 1], b = stack[vm.sp];\n","if (typeof a === 'number' && typeof b === 'number') {\n","   stack[--vm.sp] = a < b ? vm.trueObj : vm.falseObj;\n","} else { vm.pc = ",this.pc,"; vm.sendSpecial(2); if (context !== vm.activeContext || vm.breakOutOfInterpreter !== false) return}\n");case 179:return this.needsVar.stack=!0,void this.source.push("var a = stack[vm.sp - 1], b = stack[vm.sp];\n","if (typeof a === 'number' && typeof b === 'number') {\n","   stack[--vm.sp] = a > b ? vm.trueObj : vm.falseObj;\n","} else { vm.pc = ",this.pc,"; vm.sendSpecial(3); if (context !== vm.activeContext || vm.breakOutOfInterpreter !== false) return}\n");case 180:return this.needsVar.stack=!0,void this.source.push("var a = stack[vm.sp - 1], b = stack[vm.sp];\n","if (typeof a === 'number' && typeof b === 'number') {\n","   stack[--vm.sp] = a <= b ? vm.trueObj : vm.falseObj;\n","} else { vm.pc = ",this.pc,"; vm.sendSpecial(4); if (context !== vm.activeContext || vm.breakOutOfInterpreter !== false) return}\n");case 181:return this.needsVar.stack=!0,void this.source.push("var a = stack[vm.sp - 1], b = stack[vm.sp];\n","if (typeof a === 'number' && typeof b === 'number') {\n","   stack[--vm.sp] = a >= b ? vm.trueObj : vm.falseObj;\n","} else { vm.pc = ",this.pc,"; vm.sendSpecial(5); if (context !== vm.activeContext || vm.breakOutOfInterpreter !== false) return}\n");case 182:return this.needsVar.stack=!0,void this.source.push("var a = stack[vm.sp - 1], b = stack[vm.sp];\n","if (typeof a === 'number' && typeof b === 'number') {\n","   stack[--vm.sp] = a === b ? vm.trueObj : vm.falseObj;\n","} else if (a === b && a.float === a.float) {\n","   stack[--vm.sp] = vm.trueObj;\n","} else { vm.pc = ",this.pc,"; vm.sendSpecial(6); if (context !== vm.activeContext || vm.breakOutOfInterpreter !== false) return}\n");case 183:return this.needsVar.stack=!0,void this.source.push("var a = stack[vm.sp - 1], b = stack[vm.sp];\n","if (typeof a === 'number' && typeof b === 'number') {\n","   stack[--vm.sp] = a !== b ? vm.trueObj : vm.falseObj;\n","} else if (a === b && a.float === a.float) {\n","   stack[--vm.sp] = vm.falseObj;\n","} else { vm.pc = ",this.pc,"; vm.sendSpecial(7); if (context !== vm.activeContext || vm.breakOutOfInterpreter !== false) return}\n");case 184:return void this.source.push("vm.success = true; vm.resultIsFloat = false; if(!vm.pop2AndPushNumResult(vm.stackIntOrFloat(1) * vm.stackIntOrFloat(0))) { vm.pc = ",this.pc,"; vm.sendSpecial(8); return}\n");case 185:return void this.source.push("vm.success = true; if(!vm.pop2AndPushIntResult(vm.quickDivide(vm.stackInteger(1),vm.stackInteger(0)))) { vm.pc = ",this.pc,"; vm.sendSpecial(9); return}\n");case 186:return void this.source.push("vm.success = true; if(!vm.pop2AndPushIntResult(vm.mod(vm.stackInteger(1),vm.stackInteger(0)))) { vm.pc = ",this.pc,"; vm.sendSpecial(10); return}\n");case 187:return void this.source.push("vm.success = true; if(!vm.primHandler.primitiveMakePoint(1, true)) { vm.pc = ",this.pc,"; vm.sendSpecial(11); return}\n");case 188:return void this.source.push("vm.success = true; if(!vm.pop2AndPushIntResult(vm.safeShift(vm.stackInteger(1),vm.stackInteger(0)))) { vm.pc = ",this.pc,"; vm.sendSpecial(12); return}\n");case 189:return void this.source.push("vm.success = true; if(!vm.pop2AndPushIntResult(vm.div(vm.stackInteger(1),vm.stackInteger(0)))) { vm.pc = ",this.pc,"; vm.sendSpecial(13); return}\n");case 190:return void this.source.push("vm.success = true; if(!vm.pop2AndPushIntResult(vm.stackInteger(1) & vm.stackInteger(0))) { vm.pc = ",this.pc,"; vm.sendSpecial(14); return}\n");case 191:return void this.source.push("vm.success = true; if(!vm.pop2AndPushIntResult(vm.stackInteger(1) | vm.stackInteger(0))) { vm.pc = ",this.pc,"; vm.sendSpecial(15); return}\n")}},generateSend:function(t,e,s,i,r){this.debug&&this.generateDebugCode("send "+("lit["===t?this.method.pointers[e].bytesAsString():"...")),this.generateLabel(),this.needsVar[t]=!0,this.needsVar.context=!0,this.source.push("vm.pc = ",this.pc,"; vm.send(",t,e,s,", ",i,", ",r,"); ","if (context !== vm.activeContext || vm.breakOutOfInterpreter !== false) return;\n"),this.needsBreak=!1,this.needsLabel[this.pc]=!0},generateClosureTemps:function(t,e){if(this.debug&&this.generateDebugCode("closure temps"),this.generateLabel(),this.needsVar.stack=!0,this.source.push("var array = vm.instantiateClass(vm.specialObjects[7], ",t,");\n"),e){for(var s=0;s<t;s++)this.source.push("array.pointers[",s,"] = stack[vm.sp - ",t-s-1,"];\n");this.source.push("stack[vm.sp -= ",t-1,"] = array;\n")}else this.source.push("stack[++vm.sp] = array;\n")},generateClosureCopy:function(t,e,s){var i=this.pc,r=i+s;if(this.debug&&this.generateDebugCode("push closure("+i+"-"+(r-1)+"): "+e+" copied, "+t+" args"),this.generateLabel(),this.needsVar.stack=!0,this.source.push("var closure = vm.instantiateClass(vm.specialObjects[36], ",e,");\n","closure.pointers[0] = context; vm.reclaimableContextCount = 0;\n","closure.pointers[1] = ",i+4*this.method.pointers.length+1,";\n","closure.pointers[2] = ",t,";\n"),0<e){for(var n=0;n<e;n++)this.source.push("closure.pointers[",n+3,"] = stack[vm.sp - ",e-n-1,"];\n");this.source.push("stack[vm.sp -= ",e-1,"] = closure;\n")}else this.source.push("stack[++vm.sp] = closure;\n");this.source.push("vm.pc = ",r,";\n"),this.singleStep&&this.source.push("if (vm.breakOutOfInterpreter) return;\n"),this.source.push("continue;\n"),this.needsBreak=!1,this.needsLabel[i]=!0,this.needsLabel[r]=!0,r>this.endPC&&(this.endPC=r)},generateCallPrimitive:function(t){this.debug&&this.generateDebugCode("call primitive "+t),this.generateLabel(),129===this.method.bytes[this.pc]&&(this.needsVar.stack=!0,this.source.push("if (vm.primFailCode) {stack[vm.sp] = vm.getErrorObjectFromPrimFailCode(); vm.primFailCode = 0;}\n"))},generateDirty:function(t,e){switch(t){case"inst[":this.source.push("rcvr.dirty = true;\n");break;case"lit[":this.source.push(t,e,"].dirty = true;\n");break;case"temp[":break;default:throw Error("unexpected target "+t)}},generateLabel:function(){this.prevPC&&(this.sourceLabels[this.prevPC]=this.source.length,this.source.push("case ",this.prevPC,":\n")),this.prevPC=this.pc},generateDebugCode:function(t,e,s,i,r,n){this.needsBreak&&(this.source.push("if (vm.breakOutOfInterpreter) {vm.pc = ",this.prevPC,"; return}\n"),this.needsLabel[this.prevPC]=!0);for(var a=[],o=this.prevPC;o<this.pc;o++)a.push((this.method.bytes[o]+256).toString(16).slice(-2).toUpperCase());if(this.source.push("// ",this.prevPC," <",a.join(" "),"> ",t),e)switch(this.source.push(" "),e){case"vm.nilObj":this.source.push("nil");break;case"vm.trueObj":this.source.push("true");break;case"vm.falseObj":this.source.push("false");break;case"rcvr":this.source.push("self");break;case"stack[vm.sp]":this.source.push("top of stack");break;case"inst[":this.instVarNames?this.source.push(this.instVarNames[s]):this.source.push("inst var ",s);break;case"temp[":this.source.push("tmp",s-6),"]"!==i&&this.source.push("[",r,"]");break;case"lit[":var h=this.method.pointers[s];"]"===i?this.source.push(h):this.source.push(h.pointers[0].bytesAsString());break;default:this.source.push(e)}this.source.push("\n"),this.needsBreak=this.singleStep},generateInstruction:function(t,e){this.debug&&this.generateDebugCode(t),this.generateLabel(),this.source.push(e,";\n")},deleteUnneededLabels:function(){var t=!1;for(var e in this.sourceLabels)if(this.needsLabel[e])t=!0;else for(var s=0;s<3;s++)this.source[this.sourceLabels[e]+s]="";t||(this.source[this.sourcePos["loop-start"]]="",this.source[this.sourcePos["loop-end"]]="")},deleteUnneededVariables:function(){this.needsVar.stack&&(this.needsVar.context=!0),this.needsVar["inst["]&&(this.needsVar.rcvr=!0);for(var t=0;t<this.allVars.length;t++){var e=this.allVars[t];this.needsVar[e]||(this.source[this.sourcePos[e]]="")}}}),Object.extend(Squeak,"known classes",{BitBlt_dest:0,BitBlt_source:1,BitBlt_halftone:2,BitBlt_combinationRule:3,BitBlt_destX:4,BitBlt_destY:5,BitBlt_width:6,BitBlt_height:7,BitBlt_sourceX:8,BitBlt_sourceY:9,BitBlt_clipX:10,BitBlt_clipY:11,BitBlt_clipW:12,BitBlt_clipH:13,BitBlt_colorMap:14,BitBlt_warpBase:15,Form_bits:0,Form_width:1,Form_height:2,Form_depth:3,Form_offset:4}),Object.extend(Squeak.Primitives.prototype,"display",{displayDirty:function(){}}),Object.extend(Squeak.Primitives.prototype,"display",{primitiveScreenSize:function(){return!1},primitiveScreenDepth:function(){return!1},primitiveTestDisplayDepth:function(){return!1},primitiveBeDisplay:function(t){return this.vm.popN(t),!0},primitiveReverseDisplay:function(){return!1},primitiveDeferDisplayUpdates:function(){return!1},primitiveForceDisplayUpdate:function(){return!1},primitiveSetFullScreen:function(){return!1},primitiveShowDisplayRect:function(){return!1},primitiveBeCursor:function(t){return this.vm.popN(t),!0}}),Object.extend(Squeak,"events",{Mouse_Blue:1,Mouse_Yellow:2,Mouse_Red:4,Keyboard_Shift:8,Keyboard_Ctrl:16,Keyboard_Alt:32,Keyboard_Cmd:64,Mouse_All:7,Keyboard_All:120,EventTypeNone:0,EventTypeMouse:1,EventTypeKeyboard:2,EventTypeDragDropFiles:3,EventKeyChar:0,EventKeyDown:1,EventKeyUp:2,EventDragEnter:1,EventDragMove:2,EventDragLeave:3,EventDragDrop:4}),Object.extend(Squeak.Primitives.prototype,"input",{primitiveMouseButtons:function(){return!1},primitiveMousePoint:function(){return!1},primitiveKeyboardNext:function(){return!1},primitiveKeyboardPeek:function(){return!1},primitiveInputSemaphore:function(t){return this.vm.popNandPush(t+1,this.vm.nilObj),!0},primitiveInputWord:function(){return!1},primitiveGetNextEvent:function(){return!1},primitiveBeep:function(){return!1},primitiveClipboardText:function(){return!1}}),Object.extend(Squeak.Primitives.prototype,"initialization",{initPlugins:function(){Object.extend(this.builtinModules,{JavaScriptPlugin:this.findPluginFunctions("js_"),FilePlugin:this.findPluginFunctions("","primitive(Disable)?(File|Directory)"),DropPlugin:this.findPluginFunctions("","primitiveDropRequest"),SoundPlugin:this.findPluginFunctions("snd_"),JPEGReadWriter2Plugin:this.findPluginFunctions("jpeg2_"),SqueakFFIPrims:this.findPluginFunctions("ffi_","",!0),SecurityPlugin:{primitiveDisableImageWrite:this.fakePrimitive.bind(this,"SecurityPlugin.primitiveDisableImageWrite",0)},LocalePlugin:{primitiveTimezoneOffset:this.fakePrimitive.bind(this,"LocalePlugin.primitiveTimezoneOffset",0)}}),Object.extend(this.patchModules,{ScratchPlugin:this.findPluginFunctions("scratch_")})},findPluginFunctions:function(t,e,s){e=e||"(initialise|shutdown|prim)";var i={},r=new RegExp("^"+t+e,"i");for(var n in this)if(r.test(n)&&"function"==typeof this[n]){var a=n;t&&(a=n[t.length].toLowerCase()+n.slice(t.length+1)),i[a]=s?n:this[n].bind(this)}return i}}),registerConsolePlugin(),Object.extend(Squeak,{vmPath:"/",platformSubtype:"Browser",osVersion:navigator.userAgent,windowSystem:"headless"});var searchParams=new URL(self.location).searchParams,imageName=searchParams.get("imageName");if(imageName){var options={ignoreQuit:null!==searchParams.get("ignoreQuit")};fetchImageAndRun(imageName)}else console.error("Use search parameter 'imageName' to specify Smalltalk image (should be an URL)");